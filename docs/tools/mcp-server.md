# ä½¿ç”¨ Gemini CLI æ­é… MCP ä¼ºæœå™¨

æœ¬æ–‡ä»¶æä¾›å¦‚ä½•åœ¨ Gemini CLI ä¸­è¨­å®šèˆ‡ä½¿ç”¨ Model Context Protocolï¼ˆMCPï¼‰ä¼ºæœå™¨çš„æŒ‡å—ã€‚

## ä»€éº¼æ˜¯ MCP ä¼ºæœå™¨ï¼Ÿ

MCP ä¼ºæœå™¨æ˜¯ä¸€ç¨®æ‡‰ç”¨ç¨‹å¼ï¼Œé€é Model Context Protocolï¼ˆMCPï¼‰å°‡å·¥å…·èˆ‡è³‡æºæš´éœ²çµ¦ Gemini CLIï¼Œä½¿å…¶èƒ½èˆ‡å¤–éƒ¨ç³»çµ±åŠè³‡æ–™ä¾†æºäº’å‹•ã€‚MCP ä¼ºæœå™¨å……ç•¶ Gemini æ¨¡å‹èˆ‡æœ¬åœ°ç’°å¢ƒæˆ–å…¶ä»–æœå‹™ï¼ˆå¦‚ APIï¼‰ä¹‹é–“çš„æ©‹æ¨‘ã€‚

MCP ä¼ºæœå™¨è®“ Gemini CLI èƒ½å¤ ï¼š

- **ç™¼ç¾å·¥å…·ï¼š** é€éæ¨™æº–åŒ–çš„ schema å®šç¾©ï¼Œåˆ—å‡ºå¯ç”¨å·¥å…·ã€å…¶æè¿°èˆ‡åƒæ•¸ã€‚
- **åŸ·è¡Œå·¥å…·ï¼š** ä»¥å®šç¾©å¥½çš„åƒæ•¸å‘¼å«ç‰¹å®šå·¥å…·ï¼Œä¸¦æ¥æ”¶çµæ§‹åŒ–å›æ‡‰ã€‚
- **å­˜å–è³‡æºï¼š** å¾ç‰¹å®šè³‡æºè®€å–è³‡æ–™ï¼ˆé›–ç„¶ Gemini CLI ä¸»è¦èšç„¦æ–¼å·¥å…·åŸ·è¡Œï¼‰ã€‚

é€é MCP ä¼ºæœå™¨ï¼Œæ‚¨å¯ä»¥æ“´å…… Gemini CLI çš„èƒ½åŠ›ï¼ŒåŸ·è¡Œå…§å»ºåŠŸèƒ½ä»¥å¤–çš„æ“ä½œï¼Œä¾‹å¦‚èˆ‡è³‡æ–™åº«ã€APIã€è‡ªè¨‚è…³æœ¬æˆ–å°ˆæ¥­åŒ–å·¥ä½œæµç¨‹äº’å‹•ã€‚

## æ ¸å¿ƒæ•´åˆæ¶æ§‹

Gemini CLI é€éå…§å»ºæ–¼æ ¸å¿ƒå¥—ä»¶ï¼ˆ`packages/core/src/tools/`ï¼‰çš„é€²éšç™¼ç¾èˆ‡åŸ·è¡Œç³»çµ±ï¼Œèˆ‡ MCP ä¼ºæœå™¨æ•´åˆï¼š

### ç™¼ç¾å±¤ï¼ˆ`mcp-client.ts`ï¼‰

ç™¼ç¾æµç¨‹ç”± `discoverMcpTools()` è² è²¬å”èª¿ï¼Œå…¶æ­¥é©Ÿå¦‚ä¸‹ï¼š

1. **éæ­·å·²è¨­å®šçš„ä¼ºæœå™¨**ï¼Œæ ¹æ“šæ‚¨çš„ `settings.json` `mcpServers` è¨­å®š
2. **å»ºç«‹é€£ç·š**ï¼Œä½¿ç”¨é©ç•¶çš„å‚³è¼¸æ©Ÿåˆ¶ï¼ˆStdioã€SSE æˆ– Streamable HTTPï¼‰
3. **é€é MCP å”å®šå–å¾—å·¥å…·å®šç¾©**ï¼Œå¾æ¯å€‹ä¼ºæœå™¨æ“·å–å·¥å…·è³‡è¨Š
4. **æ·¨åŒ–èˆ‡é©—è­‰** å·¥å…· schemaï¼Œä»¥ç¢ºä¿èˆ‡ Gemini API ç›¸å®¹
5. **è¨»å†Šå·¥å…·** è‡³å…¨åŸŸå·¥å…·è¨»å†Šè¡¨ï¼Œä¸¦è™•ç†è¡çªè§£æ±º

### åŸ·è¡Œå±¤ï¼ˆ`mcp-tool.ts`ï¼‰

æ¯å€‹è¢«ç™¼ç¾çš„ MCP å·¥å…·éƒ½æœƒåŒ…è£åœ¨ `DiscoveredMCPTool` å¯¦ä¾‹ä¸­ï¼Œå…¶è² è²¬ï¼š

- **è™•ç†ç¢ºèªé‚è¼¯**ï¼Œæ ¹æ“šä¼ºæœå™¨ä¿¡ä»»è¨­å®šèˆ‡ä½¿ç”¨è€…åå¥½
- **ç®¡ç†å·¥å…·åŸ·è¡Œ**ï¼Œä»¥æ­£ç¢ºåƒæ•¸å‘¼å« MCP ä¼ºæœå™¨
- **è™•ç†å›æ‡‰**ï¼ŒåŒæ™‚ä¾›å¤§å‹èªè¨€æ¨¡å‹ (LLM) context èˆ‡ä½¿ç”¨è€…é¡¯ç¤º
- **ç¶­è­·é€£ç·šç‹€æ…‹**ï¼Œä¸¦è™•ç†é€¾æ™‚æƒ…æ³

### å‚³è¼¸æ©Ÿåˆ¶

Gemini CLI æ”¯æ´ä¸‰ç¨® MCP å‚³è¼¸é¡å‹ï¼š

- **Stdio å‚³è¼¸ï¼š** å•Ÿå‹•å­è¡Œç¨‹ï¼Œä¸¦é€é stdin/stdout æºé€š
- **SSE å‚³è¼¸ï¼š** é€£æ¥è‡³ Server-Sent Events ç«¯é»
- **Streamable HTTP å‚³è¼¸ï¼š** ä½¿ç”¨ HTTP ä¸²æµé€²è¡Œé€šè¨Š

## å¦‚ä½•è¨­å®šæ‚¨çš„ MCP ä¼ºæœå™¨

Gemini CLI æœƒåœ¨æ‚¨çš„ `settings.json` æª”æ¡ˆä¸­ï¼Œé€é `mcpServers` è¨­å®šä¾†å°‹æ‰¾ä¸¦é€£æ¥ MCP ä¼ºæœå™¨ã€‚æ­¤è¨­å®šæ”¯æ´å¤šå€‹ä¼ºæœå™¨åŠä¸åŒçš„å‚³è¼¸æ©Ÿåˆ¶ã€‚

### åœ¨ settings.json ä¸­è¨­å®š MCP ä¼ºæœå™¨

æ‚¨å¯ä»¥åœ¨ `settings.json` æª”æ¡ˆä¸­ï¼Œé€éå…©ç¨®ä¸»è¦æ–¹å¼è¨­å®š MCP ä¼ºæœå™¨ï¼šä¸€æ˜¯ä½¿ç”¨é ‚å±¤çš„ `mcpServers` ç‰©ä»¶ä¾†å®šç¾©ç‰¹å®šä¼ºæœå™¨ï¼ŒäºŒæ˜¯é€é `mcp` ç‰©ä»¶ä¾†é€²è¡Œä¼ºæœå™¨ç™¼ç¾èˆ‡åŸ·è¡Œçš„å…¨åŸŸè¨­å®šã€‚

#### å…¨åŸŸ MCP è¨­å®šï¼ˆ`mcp`ï¼‰

æ‚¨çš„ `settings.json` ä¸­çš„ `mcp` ç‰©ä»¶ï¼Œå¯ç”¨ä¾†ç‚ºæ‰€æœ‰ MCP ä¼ºæœå™¨å®šç¾©å…¨åŸŸè¦å‰‡ã€‚

- **`mcp.serverCommand`**ï¼ˆå­—ä¸²ï¼‰ï¼šå•Ÿå‹• MCP ä¼ºæœå™¨çš„å…¨åŸŸæŒ‡ä»¤ã€‚
- **`mcp.allowed`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šå…è¨±é€£ç·šçš„ MCP ä¼ºæœå™¨åç¨±æ¸…å–®ã€‚è‹¥è¨­å®šæ­¤é …ï¼Œåƒ…æœƒé€£ç·šæ­¤æ¸…å–®ä¸­ï¼ˆèˆ‡ `mcpServers` ç‰©ä»¶éµå€¼ç›¸ç¬¦ï¼‰çš„ä¼ºæœå™¨ã€‚
- **`mcp.excluded`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šæ’é™¤é€£ç·šçš„ MCP ä¼ºæœå™¨åç¨±æ¸…å–®ã€‚æ­¤æ¸…å–®ä¸­çš„ä¼ºæœå™¨å°‡ä¸æœƒè¢«é€£ç·šã€‚

**ç¯„ä¾‹ï¼š**

```json
{
  "mcp": {
    "allowed": ["my-trusted-server"],
    "excluded": ["experimental-server"]
  }
}
```

#### ä¼ºæœå™¨å°ˆå±¬è¨­å®šï¼ˆ`mcpServers`ï¼‰

`mcpServers` ç‰©ä»¶æ˜¯ç”¨ä¾†å®šç¾©æ¯ä¸€å€‹ä½ å¸Œæœ›å‘½ä»¤åˆ—ä»‹é¢ï¼ˆCLIï¼‰é€£ç·šçš„ MCP ä¼ºæœå™¨ã€‚

### è¨­å®šçµæ§‹

åœ¨ä½ çš„ `settings.json` æª”æ¡ˆä¸­æ–°å¢ä¸€å€‹ `mcpServers` ç‰©ä»¶ï¼š

```json
{ ...file contains other config objects
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### è¨­å®šå±¬æ€§

æ¯å€‹ä¼ºæœå™¨è¨­å®šæ”¯æ´ä»¥ä¸‹å±¬æ€§ï¼š

#### å¿…è¦ï¼ˆä»¥ä¸‹æ“‡ä¸€ï¼‰

- **`command`**ï¼ˆå­—ä¸²ï¼‰ï¼šStdio å‚³è¼¸æ–¹å¼çš„å¯åŸ·è¡Œæª”è·¯å¾‘
- **`url`**ï¼ˆå­—ä¸²ï¼‰ï¼šSSE ç«¯é» URLï¼ˆä¾‹å¦‚ï¼š`"http://localhost:8080/sse"`ï¼‰
- **`httpUrl`**ï¼ˆå­—ä¸²ï¼‰ï¼šHTTP ä¸²æµç«¯é» URL

#### é¸ç”¨

- **`args`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šStdio å‚³è¼¸æ–¹å¼çš„å‘½ä»¤åˆ—åƒæ•¸
- **`headers`**ï¼ˆç‰©ä»¶ï¼‰ï¼šä½¿ç”¨ `url` æˆ– `httpUrl` æ™‚çš„è‡ªè¨‚ HTTP æ¨™é ­
- **`env`**ï¼ˆç‰©ä»¶ï¼‰ï¼šä¼ºæœå™¨ç¨‹åºçš„ç’°å¢ƒè®Šæ•¸ã€‚å€¼å¯ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` èªæ³•åƒç…§ç’°å¢ƒè®Šæ•¸
- **`cwd`**ï¼ˆå­—ä¸²ï¼‰ï¼šStdio å‚³è¼¸æ–¹å¼çš„å·¥ä½œç›®éŒ„
- **`timeout`**ï¼ˆæ•¸å­—ï¼‰ï¼šè«‹æ±‚é€¾æ™‚æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ï¼Œé è¨­ç‚º 600,000msï¼ˆ10 åˆ†é˜ï¼‰
- **`trust`**ï¼ˆå¸ƒæ—å€¼ï¼‰ï¼šç•¶ `true` æ™‚ï¼Œç•¥éæ­¤ä¼ºæœå™¨çš„æ‰€æœ‰å·¥å…·å‘¼å«ç¢ºèªï¼ˆé è¨­ï¼š`false`ï¼‰
- **`includeTools`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šè¦å¾æ­¤ MCP ä¼ºæœå™¨ç´å…¥çš„å·¥å…·åç¨±æ¸…å–®ã€‚è‹¥æŒ‡å®šï¼Œåƒ…æ­¤æ¸…å–®ä¸­çš„å·¥å…·æœƒå¾è©²ä¼ºæœå™¨æä¾›ï¼ˆç™½åå–®è¡Œç‚ºï¼‰ã€‚è‹¥æœªæŒ‡å®šï¼Œé è¨­å•Ÿç”¨ä¼ºæœå™¨ä¸Šçš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šè¦å¾æ­¤ MCP ä¼ºæœå™¨æ’é™¤çš„å·¥å…·åç¨±æ¸…å–®ã€‚å³ä½¿ä¼ºæœå™¨æœ‰æä¾›ï¼Œé€™äº›å·¥å…·ä¹Ÿä¸æœƒå°æ¨¡å‹é–‹æ”¾ã€‚**æ³¨æ„ï¼š**`excludeTools` çš„å„ªå…ˆé †åºé«˜æ–¼ `includeTools`â€”â€”å¦‚æœå·¥å…·åŒæ™‚å‡ºç¾åœ¨å…©å€‹æ¸…å–®ï¼Œå°‡æœƒè¢«æ’é™¤ã€‚

### é ç«¯ MCP ä¼ºæœå™¨çš„ OAuth æ”¯æ´

Gemini CLI æ”¯æ´é ç«¯ MCP ä¼ºæœå™¨ï¼ˆä½¿ç”¨ SSE æˆ– HTTP å‚³è¼¸æ–¹å¼ï¼‰çš„ OAuth 2.0 é©—è­‰ã€‚é€™å¯è®“éœ€è¦é©—è­‰çš„ MCP ä¼ºæœå™¨å®‰å…¨å­˜å–ã€‚

#### è‡ªå‹• OAuth æ¢ç´¢

å°æ–¼æ”¯æ´ OAuth æ¢ç´¢çš„ä¼ºæœå™¨ï¼Œä½ å¯ä»¥çœç•¥ OAuth è¨­å®šï¼Œè®“ CLI è‡ªå‹•åµæ¸¬ï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

å‘½ä»¤åˆ—ä»‹é¢ (CLI) æœƒè‡ªå‹•åŸ·è¡Œä»¥ä¸‹å‹•ä½œï¼š

- åµæ¸¬ä¼ºæœå™¨æ˜¯å¦éœ€è¦ OAuth é©—è­‰ï¼ˆ401 å›æ‡‰ï¼‰
- å¾ä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™è‡ªå‹•ç™¼ç¾ OAuth ç«¯é»
- è‹¥æ”¯æ´ï¼Œå‰‡åŸ·è¡Œå‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Š
- è™•ç† OAuth æµç¨‹èˆ‡æ¬Šæ–ç®¡ç†

#### é©—è­‰æµç¨‹

ç•¶é€£ç·šè‡³æ”¯æ´ OAuth çš„ä¼ºæœå™¨æ™‚ï¼š

1. **åˆæ¬¡é€£ç·šå˜—è©¦** å›  401 Unauthorized å¤±æ•—
2. **OAuth æ¢ç´¢** å–å¾—æˆæ¬Šèˆ‡æ¬Šæ–ç«¯é»
3. **ç€è¦½å™¨è‡ªå‹•é–‹å•Ÿ** ä»¥é€²è¡Œä½¿ç”¨è€…é©—è­‰ï¼ˆéœ€æœ¬æ©Ÿå¯å­˜å–ç€è¦½å™¨ï¼‰
4. **æˆæ¬Šç¢¼** äº¤æ›ç‚ºå­˜å–æ¬Šæ–
5. **æ¬Šæ–æœƒè¢«å®‰å…¨å„²å­˜** ä»¥ä¾›æ—¥å¾Œä½¿ç”¨
6. **é‡æ–°å˜—è©¦é€£ç·š**ï¼Œä½¿ç”¨æœ‰æ•ˆæ¬Šæ–å³å¯æˆåŠŸ

#### ç€è¦½å™¨é‡æ–°å°å‘éœ€æ±‚

**é‡è¦ï¼š** OAuth é©—è­‰éœ€è¦æ‚¨çš„æœ¬æ©Ÿèƒ½å¤ ï¼š

- é–‹å•Ÿç¶²é ç€è¦½å™¨ä»¥é€²è¡Œé©—è­‰
- åœ¨ `http://localhost:7777/oauth/callback` ä¸Šæ¥æ”¶é‡æ–°å°å‘

æ­¤åŠŸèƒ½ç„¡æ³•åœ¨ä»¥ä¸‹ç’°å¢ƒé‹ä½œï¼š

- ç„¡æ³•å­˜å–ç€è¦½å™¨çš„ç„¡é ­ï¼ˆheadlessï¼‰ç’°å¢ƒ
- æœªå•Ÿç”¨ X11 è½‰ç™¼çš„é ç«¯ SSH é€£ç·š
- ä¸æ”¯æ´ç€è¦½å™¨çš„å®¹å™¨åŒ–ï¼ˆcontainerizedï¼‰ç’°å¢ƒ

#### ç®¡ç† OAuth é©—è­‰

è«‹ä½¿ç”¨ `/mcp auth` æŒ‡ä»¤ä¾†ç®¡ç† OAuth é©—è­‰ï¼š

```bash
# List servers requiring authentication
/mcp auth

# Authenticate with a specific server
/mcp auth serverName

# Re-authenticate if tokens expire
/mcp auth serverName
```

#### OAuth è¨­å®šå±¬æ€§

- **`enabled`**ï¼ˆå¸ƒæ—å€¼ï¼‰ï¼šå•Ÿç”¨æ­¤ä¼ºæœå™¨çš„ OAuth
- **`clientId`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth ç”¨æˆ¶ç«¯è­˜åˆ¥ç¢¼ï¼ˆå‹•æ…‹è¨»å†Šæ™‚å¯é¸å¡«ï¼‰
- **`clientSecret`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth ç”¨æˆ¶ç«¯å¯†é‘°ï¼ˆå…¬é–‹ç”¨æˆ¶ç«¯å¯é¸å¡«ï¼‰
- **`authorizationUrl`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth æˆæ¬Šç«¯é»ï¼ˆè‹¥æœªå¡«å¯«å‰‡è‡ªå‹•ç™¼ç¾ï¼‰
- **`tokenUrl`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth æ¬Šæ–ç«¯é»ï¼ˆè‹¥æœªå¡«å¯«å‰‡è‡ªå‹•ç™¼ç¾ï¼‰
- **`scopes`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šæ‰€éœ€çš„ OAuth æ¬Šæ–ç¯„åœï¼ˆscopesï¼‰
- **`redirectUri`**ï¼ˆå­—ä¸²ï¼‰ï¼šè‡ªè¨‚é‡æ–°å°å‘ URIï¼ˆé è¨­ç‚º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`**ï¼ˆå­—ä¸²ï¼‰ï¼šSSE URL ä¸­æ¬Šæ–çš„æŸ¥è©¢åƒæ•¸åç¨±
- **`audiences`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šæ¬Šæ–æœ‰æ•ˆçš„å—çœ¾ï¼ˆaudiencesï¼‰

#### æ¬Šæ–ç®¡ç†

OAuth æ¬Šæ–æœƒè‡ªå‹•ï¼š

- **å®‰å…¨å„²å­˜**æ–¼ `~/.gemini/mcp-oauth-tokens.json`
- **åœ¨éæœŸæ™‚è‡ªå‹•åˆ·æ–°**ï¼ˆè‹¥æœ‰æä¾› refresh tokenï¼‰
- **æ–¼æ¯æ¬¡é€£ç·šå˜—è©¦å‰é©—è­‰**
- **åœ¨æ¬Šæ–ç„¡æ•ˆæˆ–éæœŸæ™‚è‡ªå‹•æ¸…é™¤**

#### é©—è­‰æä¾›è€…é¡å‹

ä½ å¯ä»¥é€é `authProviderType` å±¬æ€§æŒ‡å®šé©—è­‰æä¾›è€…é¡å‹ï¼š

- **`authProviderType`**ï¼ˆå­—ä¸²ï¼‰ï¼šæŒ‡å®šé©—è­‰æä¾›è€…ã€‚å¯ç‚ºä¸‹åˆ—å…¶ä¸­ä¹‹ä¸€ï¼š
  - **`dynamic_discovery`**ï¼ˆé è¨­ï¼‰ï¼šå‘½ä»¤åˆ—ä»‹é¢ (CLI) æœƒè‡ªå‹•å¾ä¼ºæœå™¨ç™¼ç¾ OAuth è¨­å®šã€‚
  - **`google_credentials`**ï¼šå‘½ä»¤åˆ—ä»‹é¢ (CLI) æœƒä½¿ç”¨ Google Application Default Credentialsï¼ˆADCï¼ŒGoogle æ‡‰ç”¨ç¨‹å¼é è¨­æ†‘è­‰ï¼‰ä¾†é©—è­‰ä¼ºæœå™¨ã€‚ä½¿ç”¨æ­¤æä¾›è€…æ™‚ï¼Œå¿…é ˆæŒ‡å®šæ‰€éœ€çš„æ¬Šæ–ç¯„åœï¼ˆscopesï¼‰ã€‚

```json
{
  "mcpServers": {
    "googleCloudServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "google_credentials",
      "oauth": {
        "scopes": ["https://www.googleapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

### ç¯„ä¾‹è¨­å®š

#### Python MCP ä¼ºæœå™¨ï¼ˆStdioï¼‰

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP Server (Stdio)


#### Node.js MCP ä¼ºæœå™¨ï¼ˆStdioï¼‰

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºæ–¼ Docker çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºæ–¼ HTTP çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### æ”¯æ´è‡ªè¨‚æ¨™é ­çš„ HTTP å‹ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å…·å‚™å·¥å…·éæ¿¾åŠŸèƒ½çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

## æ¢ç´¢æµç¨‹æ·±åº¦è§£æ

ç•¶ Gemini CLI å•Ÿå‹•æ™‚ï¼Œæœƒé€éä»¥ä¸‹è©³ç´°æµç¨‹é€²è¡Œ MCP ä¼ºæœå™¨çš„æ¢ç´¢ï¼š

### 1. ä¼ºæœå™¨è¿­ä»£èˆ‡é€£ç·š

é‡å° `mcpServers` ä¸­è¨­å®šçš„æ¯ä¸€å€‹ä¼ºæœå™¨ï¼š

1. **é–‹å§‹ç‹€æ…‹è¿½è¹¤ï¼š** ä¼ºæœå™¨ç‹€æ…‹è¨­ç‚º `CONNECTING`
2. **å‚³è¼¸æ–¹å¼é¸æ“‡ï¼š** æ ¹æ“šçµ„æ…‹å±¬æ€§é¸æ“‡ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **å»ºç«‹é€£ç·šï¼š** MCP ç”¨æˆ¶ç«¯æœƒåœ¨è¨­å®šçš„é€¾æ™‚æ™‚é–“å…§å˜—è©¦é€£ç·š
4. **éŒ¯èª¤è™•ç†ï¼š** é€£ç·šå¤±æ•—æ™‚æœƒè¨˜éŒ„æ—¥èªŒï¼Œä¸¦å°‡ä¼ºæœå™¨ç‹€æ…‹è¨­ç‚º `DISCONNECTED`

### 2. å·¥å…·æ¢ç´¢

æˆåŠŸé€£ç·šå¾Œï¼š

1. **å·¥å…·æ¸…å–®ï¼š** ç”¨æˆ¶ç«¯å‘¼å« MCP ä¼ºæœå™¨çš„å·¥å…·æ¸…å–®ç«¯é»
2. **çµæ§‹é©—è­‰ï¼š** é©—è­‰æ¯å€‹å·¥å…·çš„å‡½å¼å®£å‘Š
3. **å·¥å…·éæ¿¾ï¼š** æ ¹æ“š `includeTools` å’Œ `excludeTools` çµ„æ…‹éæ¿¾å·¥å…·
4. **åç¨±æ·¨åŒ–ï¼š** å·¥å…·åç¨±æœƒæ¸…ç†ä»¥ç¬¦åˆ Gemini API è¦æ±‚ï¼š
   - ç„¡æ•ˆå­—å…ƒï¼ˆéè‹±æ•¸å­—ã€åº•ç·šã€é»ã€é€£å­—è™Ÿï¼‰æœƒè¢«åº•ç·šå–ä»£
   - è¶…é 63 å€‹å­—å…ƒçš„åç¨±æœƒä»¥ä¸­é–“æ›¿æ›ï¼ˆ`___`ï¼‰æ–¹å¼æˆªæ–·

### 3. è¡çªè§£æ±º

ç•¶å¤šå€‹ä¼ºæœå™¨æä¾›åŒåå·¥å…·æ™‚ï¼š

1. **å…ˆè¨»å†Šè€…å„ªå…ˆï¼š** ç¬¬ä¸€å€‹è¨»å†Šè©²å·¥å…·åç¨±çš„ä¼ºæœå™¨å¯ç²å¾—æœªåŠ å‰ç¶´çš„åç¨±
2. **è‡ªå‹•åŠ å‰ç¶´ï¼š** å¾ŒçºŒä¼ºæœå™¨æœƒç²å¾—åŠ ä¸Šå‰ç¶´çš„åç¨±ï¼š`serverName__toolName`
3. **è¨»å†Šè¡¨è¿½è¹¤ï¼š** å·¥å…·è¨»å†Šè¡¨æœƒç¶­è­·ä¼ºæœå™¨åç¨±èˆ‡å…¶å·¥å…·ä¹‹é–“çš„å°æ‡‰é—œä¿‚

### 4. çµæ§‹è™•ç†

å·¥å…·åƒæ•¸çµæ§‹æœƒé€²è¡Œæ·¨åŒ–ï¼Œä»¥ç¢ºä¿èˆ‡ Gemini API ç›¸å®¹ï¼š

- **`$schema` å±¬æ€§** æœƒè¢«ç§»é™¤
- **`additionalProperties`** æœƒè¢«å»é™¤
- **å¸¶æœ‰ `default` çš„ `anyOf`** å…¶é è¨­å€¼æœƒè¢«ç§»é™¤ï¼ˆVertex AI ç›¸å®¹æ€§ï¼‰
- **éè¿´è™•ç†** æœƒå¥—ç”¨æ–¼å·¢ç‹€çµæ§‹

### 5. é€£ç·šç®¡ç†

æ¢ç´¢å®Œæˆå¾Œï¼š

- **æŒä¹…é€£ç·šï¼š** æˆåŠŸè¨»å†Šå·¥å…·çš„ä¼ºæœå™¨æœƒç¶­æŒé€£ç·š
- **æ¸…ç†ï¼š** æœªæä¾›å¯ç”¨å·¥å…·çš„ä¼ºæœå™¨æœƒé—œé–‰é€£ç·š
- **ç‹€æ…‹æ›´æ–°ï¼š** æœ€çµ‚ä¼ºæœå™¨ç‹€æ…‹æœƒè¨­ç‚º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·åŸ·è¡Œæµç¨‹

ç•¶ Gemini æ¨¡å‹æ±ºå®šä½¿ç”¨æŸå€‹ MCP å·¥å…·æ™‚ï¼Œæœƒç™¼ç”Ÿä»¥ä¸‹åŸ·è¡Œæµç¨‹ï¼š

### 1. å·¥å…·å‘¼å«

æ¨¡å‹æœƒç”¢ç”Ÿ `FunctionCall`ï¼Œå…§å®¹åŒ…å«ï¼š

- **å·¥å…·åç¨±ï¼š** è¨»å†Šåç¨±ï¼ˆå¯èƒ½åŒ…å«å‰ç¶´ï¼‰
- **åƒæ•¸ï¼š** èˆ‡å·¥å…·åƒæ•¸çµæ§‹ç›¸ç¬¦çš„ JSON ç‰©ä»¶

### 2. ç¢ºèªæµç¨‹

æ¯å€‹ `DiscoveredMCPTool` éƒ½æœƒå¯¦ä½œé€²éšçš„ç¢ºèªé‚è¼¯ï¼š

#### åŸºæ–¼ä¿¡ä»»çš„ç•¥é

```typescript
if (this.trust) {
  return false; // No confirmation needed
}
```

#### å‹•æ…‹å…è¨±æ¸…å–®ï¼ˆAllow-listingï¼‰

ç³»çµ±æœƒç¶­è­·å…§éƒ¨å…è¨±æ¸…å–®ï¼Œåˆ†ç‚ºï¼š

- **ä¼ºæœå™¨å±¤ç´šï¼š** `serverName` â†’ ä¾†è‡ªæ­¤ MCP ä¼ºæœå™¨çš„æ‰€æœ‰å·¥å…·çš†è¢«ä¿¡ä»»
- **å·¥å…·å±¤ç´šï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·è¢«ä¿¡ä»»

#### ä½¿ç”¨è€…é¸æ“‡è™•ç†

ç•¶éœ€è¦ç¢ºèªæ™‚ï¼Œä½¿ç”¨è€…å¯ä»¥é¸æ“‡ï¼š

- **åƒ…åŸ·è¡Œä¸€æ¬¡ï¼š** åªåŸ·è¡Œé€™ä¸€æ¬¡
- **æ°¸é å…è¨±æ­¤å·¥å…·ï¼š** åŠ å…¥å·¥å…·å±¤ç´šå…è¨±æ¸…å–®
- **æ°¸é å…è¨±æ­¤ä¼ºæœå™¨ï¼š** åŠ å…¥ä¼ºæœå™¨å±¤ç´šå…è¨±æ¸…å–®
- **å–æ¶ˆï¼š** ä¸­æ­¢åŸ·è¡Œ

### 3. åŸ·è¡Œ

ç¶“éç¢ºèªï¼ˆæˆ–ä¿¡ä»»ç¹éï¼‰å¾Œï¼š

1. **åƒæ•¸æº–å‚™ï¼š** åƒæ•¸æœƒä¾æ“šå·¥å…·çš„ schema é€²è¡Œé©—è­‰
2. **MCP å‘¼å«ï¼š** åº•å±¤çš„ `CallableTool` æœƒä»¥ä»¥ä¸‹æ–¹å¼å‘¼å«ä¼ºæœå™¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // Original server tool name
       args: params,
     },
   ];
   ```

3. **å›æ‡‰è™•ç†ï¼š** çµæœæœƒåŒæ™‚æ ¼å¼åŒ–ï¼Œæä¾›å¤§å‹èªè¨€æ¨¡å‹ (LLM) çš„ context èˆ‡ç”¨æˆ¶é¡¯ç¤º

### 4. å›æ‡‰è™•ç†

åŸ·è¡ŒçµæœåŒ…å«ï¼š

- **`llmContent`ï¼š** æä¾›çµ¦å¤§å‹èªè¨€æ¨¡å‹ (LLM) context çš„åŸå§‹å›æ‡‰éƒ¨åˆ†
- **`returnDisplay`ï¼š** æ ¼å¼åŒ–å¾Œçš„è¼¸å‡ºï¼Œä¾›ç”¨æˆ¶é¡¯ç¤ºï¼ˆé€šå¸¸æ˜¯åœ¨ markdown ç¨‹å¼ç¢¼å€å¡Šä¸­çš„ JSONï¼‰

## å¦‚ä½•èˆ‡ä½ çš„ MCP ä¼ºæœå™¨äº’å‹•

### ä½¿ç”¨ `/mcp` æŒ‡ä»¤

`/mcp` æŒ‡ä»¤å¯æä¾›æœ‰é—œä½ çš„ MCP ä¼ºæœå™¨è¨­å®šçš„å®Œæ•´è³‡è¨Šï¼š

```bash
/mcp
```

é€™æœƒé¡¯ç¤ºï¼š

- **ä¼ºæœå™¨æ¸…å–®ï¼š** æ‰€æœ‰å·²è¨­å®šçš„ MCP ä¼ºæœå™¨
- **é€£ç·šç‹€æ…‹ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **ä¼ºæœå™¨è©³ç´°è³‡è¨Šï¼š** è¨­å®šæ‘˜è¦ï¼ˆä¸åŒ…å«æ•æ„Ÿè³‡æ–™ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** æ¯å€‹ä¼ºæœå™¨æ‰€æä¾›çš„å·¥å…·æ¸…å–®åŠå…¶èªªæ˜
- **æ¢ç´¢ç‹€æ…‹ï¼š** æ•´é«”æ¢ç´¢ç¨‹åºçš„ç‹€æ…‹

### ç¯„ä¾‹ `/mcp` è¼¸å‡º

```
MCP Servers Status:

ğŸ“¡ pythonTools (CONNECTED)
  Command: python -m my_mcp_server --port 8080
  Working Directory: ./mcp-servers/python
  Timeout: 15000ms
  Tools: calculate_sum, file_analyzer, data_processor

ğŸ”Œ nodeServer (DISCONNECTED)
  Command: node dist/server.js --verbose
  Error: Connection refused

ğŸ³ dockerizedServer (CONNECTED)
  Command: docker run -i --rm -e API_KEY my-mcp-server:latest
  Tools: docker__deploy, docker__status

Discovery State: COMPLETED
```

### å·¥å…·ä½¿ç”¨æ–¹å¼

ä¸€æ—¦è¢«ç™¼ç¾ï¼ŒMCP å·¥å…·å°±æœƒåƒå…§å»ºå·¥å…·ä¸€æ¨£æä¾›çµ¦ Gemini æ¨¡å‹ä½¿ç”¨ã€‚æ¨¡å‹æœƒè‡ªå‹•ï¼š

1. **æ ¹æ“šä½ çš„è«‹æ±‚é¸æ“‡åˆé©çš„å·¥å…·**
2. **é¡¯ç¤ºç¢ºèªå°è©±æ¡†**ï¼ˆé™¤éä¼ºæœå™¨è¢«ä¿¡ä»»ï¼‰
3. **ä»¥æ­£ç¢ºçš„åƒæ•¸åŸ·è¡Œå·¥å…·**
4. **ä»¥æ˜“æ–¼é–±è®€çš„æ ¼å¼é¡¯ç¤ºçµæœ**

## ç‹€æ…‹ç›£æ§èˆ‡ç–‘é›£æ’è§£

### é€£ç·šç‹€æ…‹

MCP æ•´åˆæœƒè¿½è¹¤å¤šç¨®ç‹€æ…‹ï¼š

#### ä¼ºæœå™¨ç‹€æ…‹ (`MCPServerStatus`)

- **`DISCONNECTED`ï¼š** ä¼ºæœå™¨æœªé€£ç·šæˆ–ç™¼ç”ŸéŒ¯èª¤
- **`CONNECTING`ï¼š** æ­£åœ¨å˜—è©¦é€£ç·š
- **`CONNECTED`ï¼š** ä¼ºæœå™¨å·²é€£ç·šä¸”å¯ç”¨

#### æ¢ç´¢ç‹€æ…‹ (`MCPDiscoveryState`)

- **`NOT_STARTED`ï¼š** å°šæœªé–‹å§‹æ¢ç´¢
- **`IN_PROGRESS`ï¼š** ç›®å‰æ­£åœ¨æ¢ç´¢ä¼ºæœå™¨
- **`COMPLETED`ï¼š** æ¢ç´¢å·²å®Œæˆï¼ˆä¸è«–æ˜¯å¦æœ‰éŒ¯èª¤ï¼‰

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ³•

#### ä¼ºæœå™¨ç„¡æ³•é€£ç·š

**ç—‡ç‹€ï¼š** ä¼ºæœå™¨é¡¯ç¤º `DISCONNECTED` ç‹€æ…‹

**ç–‘é›£æ’è§£ï¼š**

1. **æª¢æŸ¥è¨­å®šï¼š** ç¢ºèª `command`ã€`args` å’Œ `cwd` æ˜¯å¦æ­£ç¢º
2. **æ‰‹å‹•æ¸¬è©¦ï¼š** ç›´æ¥åŸ·è¡Œä¼ºæœå™¨æŒ‡ä»¤ä»¥ç¢ºä¿å…¶å¯é‹ä½œ
3. **æª¢æŸ¥ç›¸ä¾å¥—ä»¶ï¼š** ç¢ºèªæ‰€æœ‰å¿…è¦çš„å¥—ä»¶éƒ½å·²å®‰è£
4. **æª¢æŸ¥æ—¥èªŒï¼š** åœ¨å‘½ä»¤åˆ—ä»‹é¢ (CLI) è¼¸å‡ºä¸­å°‹æ‰¾éŒ¯èª¤è¨Šæ¯
5. **æª¢æŸ¥æ¬Šé™ï¼š** ç¢ºèªå‘½ä»¤åˆ—ä»‹é¢ (CLI) æœ‰æ¬ŠåŸ·è¡Œä¼ºæœå™¨æŒ‡ä»¤

#### æœªç™¼ç¾ä»»ä½•å·¥å…·

**ç—‡ç‹€ï¼š** ä¼ºæœå™¨å·²é€£ç·šä½†æ²’æœ‰å¯ç”¨å·¥å…·

**ç–‘é›£æ’è§£ï¼š**

1. **ç¢ºèªå·¥å…·è¨»å†Šï¼š** ç¢ºèªä½ çš„ä¼ºæœå™¨ç¢ºå¯¦æœ‰è¨»å†Šå·¥å…·
2. **æª¢æŸ¥ MCP å”å®šï¼š** ç¢ºèªä½ çš„ä¼ºæœå™¨æ­£ç¢ºå¯¦ä½œ MCP å·¥å…·æ¸…å–®åŠŸèƒ½
3. **æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒï¼š** æª¢æŸ¥ stderr è¼¸å‡ºæ˜¯å¦æœ‰ä¼ºæœå™¨ç«¯éŒ¯èª¤
4. **æ¸¬è©¦å·¥å…·æ¸…å–®ï¼š** æ‰‹å‹•æ¸¬è©¦ä¼ºæœå™¨çš„å·¥å…·æ¢ç´¢ç«¯é»

#### å·¥å…·ç„¡æ³•åŸ·è¡Œ

**ç—‡ç‹€ï¼š** å·¥å…·å·²è¢«ç™¼ç¾ä½†åŸ·è¡Œæ™‚å¤±æ•—

**ç–‘é›£æ’è§£ï¼š**

1. **åƒæ•¸é©—è­‰ï¼š** ç¢ºèªä½ çš„å·¥å…·èƒ½æ¥å—é æœŸçš„åƒæ•¸
2. **Schema ç›¸å®¹æ€§ï¼š** ç¢ºèªä½ çš„è¼¸å…¥ schema ç‚ºæœ‰æ•ˆçš„ JSON Schema
3. **éŒ¯èª¤è™•ç†ï¼š** æª¢æŸ¥ä½ çš„å·¥å…·æ˜¯å¦æœ‰æœªè™•ç†çš„ä¾‹å¤–
4. **é€¾æ™‚å•é¡Œï¼š** è€ƒæ…®å¢åŠ  `timeout` è¨­å®š

#### æ²™ç®±æ©Ÿåˆ¶ç›¸å®¹æ€§

**ç—‡ç‹€ï¼š** å•Ÿç”¨æ²™ç®±æ©Ÿåˆ¶æ™‚ MCP ä¼ºæœå™¨å¤±æ•—

**è§£æ±ºæ–¹æ³•ï¼š**

1. **åŸºæ–¼ Docker çš„ä¼ºæœå™¨ï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ç›¸ä¾å¥—ä»¶çš„ Docker å®¹å™¨
2. **è·¯å¾‘å¯å­˜å–æ€§ï¼š** ç¢ºèªä¼ºæœå™¨å¯åŸ·è¡Œæª”åœ¨æ²™ç®±å…§å¯ç”¨
3. **ç¶²è·¯å­˜å–ï¼š** è¨­å®šæ²™ç®±å…è¨±å¿…è¦çš„ç¶²è·¯é€£ç·š
4. **ç’°å¢ƒè®Šæ•¸ï¼š** ç¢ºèªæ‰€éœ€çš„ç’°å¢ƒè®Šæ•¸æœ‰æ­£ç¢ºå‚³é

### é™¤éŒ¯å»ºè­°

1. **å•Ÿç”¨é™¤éŒ¯æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` æ——æ¨™åŸ·è¡Œå‘½ä»¤åˆ—ä»‹é¢ (CLI) ä»¥ç²å¾—è©³ç´°è¼¸å‡º
2. **æª¢æŸ¥ stderrï¼š** MCP ä¼ºæœå™¨çš„ stderr æœƒè¢«æ“·å–ä¸¦è¨˜éŒ„ï¼ˆINFO è¨Šæ¯æœƒè¢«éæ¿¾ï¼‰
3. **ç¨ç«‹æ¸¬è©¦ï¼š** åœ¨æ•´åˆå‰å…ˆç¨ç«‹æ¸¬è©¦ä½ çš„ MCP ä¼ºæœå™¨
4. **æ¼¸é€²å¼è¨­ç½®ï¼š** å…ˆå¾ç°¡å–®å·¥å…·é–‹å§‹ï¼Œå†é€æ­¥åŠ å…¥è¤‡é›œåŠŸèƒ½
5. **ç¶“å¸¸ä½¿ç”¨ `/mcp`ï¼š** é–‹ç™¼éç¨‹ä¸­æŒçºŒç›£æ§ä¼ºæœå™¨ç‹€æ…‹

## é‡è¦æ³¨æ„äº‹é …

### å®‰å…¨æ€§è€ƒé‡

- **ä¿¡ä»»è¨­å®šï¼š** `trust` é¸é …æœƒç•¥éæ‰€æœ‰ç¢ºèªå°è©±æ¡†ã€‚è«‹è¬¹æ…ä½¿ç”¨ï¼Œåƒ…ç”¨æ–¼ä½ å®Œå…¨æŒæ§çš„ä¼ºæœå™¨
- **å­˜å–æ¬Šæ–ï¼š** è¨­å®šåŒ…å« API é‡‘é‘°æˆ–æ¬Šæ–çš„ç’°å¢ƒè®Šæ•¸æ™‚ï¼Œè«‹æ³¨æ„å®‰å…¨æ€§
- **æ²™ç®±æ©Ÿåˆ¶ç›¸å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç®±æ©Ÿåˆ¶æ™‚ï¼Œè«‹ç¢ºä¿ MCP ä¼ºæœå™¨å¯åœ¨æ²™ç®±ç’°å¢ƒä¸­å­˜å–
- **ç§äººè³‡æ–™ï¼š** ä½¿ç”¨æ¬Šé™ç¯„åœéå¤§çš„å€‹äººå­˜å–æ¬Šæ–ï¼Œå¯èƒ½å°è‡´ä¸åŒå„²å­˜åº«é–“çš„è³‡è¨Šæ´©æ¼

### æ•ˆèƒ½èˆ‡è³‡æºç®¡ç†

- **é€£ç·šæŒçºŒæ€§ï¼š** å‘½ä»¤åˆ—ä»‹é¢ (CLI) æœƒå°æˆåŠŸè¨»å†Šå·¥å…·çš„ä¼ºæœå™¨ç¶­æŒæŒä¹…é€£ç·š
- **è‡ªå‹•æ¸…ç†ï¼š** å°æœªæä¾›å·¥å…·çš„ä¼ºæœå™¨é€£ç·šæœƒè‡ªå‹•é—œé–‰
- **é€¾æ™‚ç®¡ç†ï¼š** æ ¹æ“šä¼ºæœå™¨å›æ‡‰ç‰¹æ€§è¨­å®šåˆé©çš„é€¾æ™‚æ™‚é–“
- **è³‡æºç›£æ§ï¼š** MCP ä¼ºæœå™¨ä»¥ç¨ç«‹ç¨‹åºé‹è¡Œï¼Œæœƒä½”ç”¨ç³»çµ±è³‡æº

### Schema ç›¸å®¹æ€§

- **å±¬æ€§éæ¿¾ï¼š** ç³»çµ±æœƒè‡ªå‹•ç§»é™¤éƒ¨åˆ† schema å±¬æ€§ï¼ˆ`$schema`ã€`additionalProperties`ï¼‰ï¼Œä»¥ç¬¦åˆ Gemini API ç›¸å®¹æ€§
- **åç¨±æ­£è¦åŒ–ï¼š** å·¥å…·åç¨±æœƒè‡ªå‹•æ­£è¦åŒ–ä»¥ç¬¦åˆ API è¦æ±‚
- **è¡çªè§£æ±ºï¼š** ä¼ºæœå™¨é–“çš„å·¥å…·åç¨±è¡çªæœƒè‡ªå‹•åŠ ä¸Šå‰ç¶´è§£æ±º

é€™å¥—å®Œæ•´çš„æ•´åˆæ©Ÿåˆ¶ï¼Œè®“ MCP ä¼ºæœå™¨æˆç‚ºæ“´å…… Gemini CLI åŠŸèƒ½çš„å¼·å¤§æ–¹å¼ï¼ŒåŒæ™‚å…¼é¡§å®‰å…¨æ€§ã€å¯é æ€§èˆ‡æ˜“ç”¨æ€§ã€‚

## å¾å·¥å…·å›å‚³è±å¯Œå…§å®¹

MCP å·¥å…·ä¸é™æ–¼å›å‚³ç´”æ–‡å­—ã€‚ä½ å¯ä»¥åœ¨å–®ä¸€å·¥å…·å›æ‡‰ä¸­å›å‚³è±å¯Œã€å¤šå…ƒçš„å…§å®¹ï¼ŒåŒ…æ‹¬æ–‡å­—ã€åœ–ç‰‡ã€éŸ³è¨ŠåŠå…¶ä»–äºŒé€²ä½è³‡æ–™ã€‚é€™è®“ä½ èƒ½æ‰“é€ åŠŸèƒ½å¼·å¤§çš„å·¥å…·ï¼Œæ–¼å–®æ¬¡äº’å‹•ä¸­æä¾›å¤šæ¨£è³‡è¨Šçµ¦æ¨¡å‹ã€‚

æ‰€æœ‰å¾å·¥å…·å›å‚³çš„è³‡æ–™éƒ½æœƒè¢«è™•ç†ï¼Œä¸¦ä½œç‚º context å‚³éçµ¦æ¨¡å‹çš„ä¸‹ä¸€è¼ªæ¨è«–ï¼Œè®“æ¨¡å‹èƒ½é‡å°æ‰€æä¾›çš„è³‡è¨Šé€²è¡Œæ¨ç†æˆ–æ‘˜è¦ã€‚

### é‹ä½œæ–¹å¼

è‹¥è¦å›å‚³è±å¯Œå…§å®¹ï¼Œä½ çš„å·¥å…·å›æ‡‰å¿…é ˆéµå¾ª MCP è¦ç¯„ä¸­çš„ [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result)ã€‚çµæœä¸­çš„ `content` æ¬„ä½æ‡‰ç‚º `ContentBlock` ç‰©ä»¶é™£åˆ—ã€‚Gemini CLI æœƒæ­£ç¢ºè™•ç†é€™å€‹é™£åˆ—ï¼Œå°‡æ–‡å­—èˆ‡äºŒé€²ä½è³‡æ–™åˆ†é›¢ä¸¦åŒ…è£çµ¦æ¨¡å‹ã€‚

ä½ å¯ä»¥åœ¨ `content` é™£åˆ—ä¸­æ··åˆå„ç¨®å…§å®¹å€å¡Šé¡å‹ã€‚ç›®å‰æ”¯æ´çš„å€å¡Šé¡å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource`ï¼ˆå…§åµŒå…§å®¹ï¼‰
- `resource_link`

### ç¯„ä¾‹ï¼šå›å‚³æ–‡å­—èˆ‡åœ–ç‰‡

ä»¥ä¸‹æ˜¯ä¸€å€‹ MCP å·¥å…·å›å‚³æ–‡å­—æè¿°èˆ‡åœ–ç‰‡çš„æœ‰æ•ˆ JSON å›æ‡‰ç¯„ä¾‹ï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "Here is the logo you requested."
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "The logo was created in 2025."
    }
  ]
}
```

ç•¶ Gemini CLI æ”¶åˆ°æ­¤å›æ‡‰æ™‚ï¼Œå°‡æœƒï¼š

1.  æ“·å–æ‰€æœ‰æ–‡å­—ä¸¦å°‡å…¶åˆä½µç‚ºå–®ä¸€çš„ `functionResponse` éƒ¨åˆ†ï¼Œæä¾›çµ¦æ¨¡å‹ä½¿ç”¨ã€‚
2.  å°‡å½±åƒè³‡æ–™ä½œç‚ºç¨ç«‹çš„ `inlineData` éƒ¨åˆ†å‘ˆç¾ã€‚
3.  åœ¨å‘½ä»¤åˆ—ä»‹é¢ (CLI) ä¸­æä¾›ä¸€å€‹ç°¡æ½”ä¸”æ˜“æ–¼ç†è§£çš„æ‘˜è¦ï¼ŒæŒ‡å‡ºå·²æ”¶åˆ°æ–‡å­—èˆ‡å½±åƒã€‚

é€™ä½¿æ‚¨èƒ½å¤ æ‰“é€ èƒ½å¤ ç‚º Gemini æ¨¡å‹æä¾›è±å¯Œå¤šæ¨¡æ…‹ context çš„é€²éšå·¥å…·ã€‚

## ä»¥æ–œç·šæŒ‡ä»¤å½¢å¼ä½¿ç”¨ MCP Prompts

é™¤äº†å·¥å…·ä¹‹å¤–ï¼ŒMCP ä¼ºæœå™¨ä¹Ÿå¯ä»¥å…¬é–‹é å…ˆå®šç¾©çš„ promptsï¼Œè®“ä½¿ç”¨è€…èƒ½åœ¨ Gemini CLI å…§ä»¥æ–œç·šæŒ‡ä»¤ï¼ˆslash commandï¼‰æ–¹å¼åŸ·è¡Œã€‚é€™è®“æ‚¨å¯ä»¥ç‚ºå¸¸è¦‹æˆ–è¤‡é›œçš„æŸ¥è©¢å»ºç«‹æ·å¾‘ï¼Œä¸¦å¯ç›´æ¥é€éåç¨±è¼•é¬†å‘¼å«ã€‚

### åœ¨ä¼ºæœå™¨ä¸Šå®šç¾© Prompts

ä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„ stdio MCP ä¼ºæœå™¨ç¯„ä¾‹ï¼Œèªªæ˜å¦‚ä½•å®šç¾© promptsï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'Poem Writer',
    description: 'Write a nice haiku',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `Write a haiku${mood ? ` with the mood ${mood}` : ''} called ${title}. Note that a haiku is 5 syllables followed by 7 syllables followed by 5 syllables `,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

é€™å¯ä»¥é€éä»¥ä¸‹æ–¹å¼ï¼ŒåŒ…å«åœ¨`settings.json`çš„`mcpServers`ä¹‹ä¸‹ï¼š

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["filename.ts"]
    }
  }
}
```

### å‘¼å« Prompts

ç•¶ prompt è¢«ç™¼ç¾å¾Œï¼Œä½ å¯ä»¥ä½¿ç”¨å…¶åç¨±ä½œç‚ºæ–œç·šæŒ‡ä»¤ä¾†å‘¼å«å®ƒã€‚å‘½ä»¤åˆ—ä»‹é¢ (CLI) æœƒè‡ªå‹•è™•ç†åƒæ•¸çš„è§£æã€‚

```bash
/poem-writer --title="Gemini CLI" --mood="reverent"
```

æˆ–è€…ï¼Œä½¿ç”¨ä½ç½®å¼•æ•¸ï¼š

```bash
/poem-writer "Gemini CLI" reverent
```

ç•¶ä½ åŸ·è¡Œæ­¤æŒ‡ä»¤æ™‚ï¼ŒGemini CLI æœƒåœ¨ MCP ä¼ºæœå™¨ä¸Šä»¥æä¾›çš„åƒæ•¸åŸ·è¡Œ `prompts/get` æ–¹æ³•ã€‚ä¼ºæœå™¨è² è²¬å°‡åƒæ•¸ä»£å…¥æç¤ºæ¨¡æ¿ï¼Œä¸¦å›å‚³æœ€çµ‚çš„æç¤ºæ–‡å­—ã€‚CLI éš¨å¾Œæœƒå°‡é€™å€‹æç¤ºå‚³é€çµ¦æ¨¡å‹é€²è¡ŒåŸ·è¡Œã€‚é€™æä¾›äº†ä¸€ç¨®æ–¹ä¾¿çš„æ–¹å¼ä¾†è‡ªå‹•åŒ–ä¸¦åˆ†äº«å¸¸è¦‹çš„å·¥ä½œæµç¨‹ã€‚

## ä½¿ç”¨ `gemini mcp` ç®¡ç† MCP ä¼ºæœå™¨

é›–ç„¶ä½ å¯ä»¥éš¨æ™‚é€éæ‰‹å‹•ç·¨è¼¯ `settings.json` æª”æ¡ˆä¾†è¨­å®š MCP ä¼ºæœå™¨ï¼ŒGemini CLI ä¹Ÿæä¾›äº†ä¸€çµ„æ–¹ä¾¿çš„æŒ‡ä»¤ï¼Œè®“ä½ èƒ½ä»¥ç¨‹å¼åŒ–æ–¹å¼ç®¡ç†ä¼ºæœå™¨è¨­å®šã€‚é€™äº›æŒ‡ä»¤ç°¡åŒ–äº†æ–°å¢ã€åˆ—å‡ºåŠç§»é™¤ MCP ä¼ºæœå™¨çš„æµç¨‹ï¼Œç„¡éœ€ç›´æ¥ç·¨è¼¯ JSON æª”æ¡ˆã€‚

### æ–°å¢ä¼ºæœå™¨ (`gemini mcp add`)

`add` æŒ‡ä»¤æœƒåœ¨ä½ çš„ `settings.json` ä¸­è¨­å®šä¸€å€‹æ–°çš„ MCP ä¼ºæœå™¨ã€‚æ ¹æ“šä½œç”¨ç¯„åœ (`-s, --scope`)ï¼Œå®ƒæœƒè¢«åŠ å…¥åˆ°ä½¿ç”¨è€…è¨­å®š `~/.gemini/settings.json` æˆ–å°ˆæ¡ˆè¨­å®š `.gemini/settings.json` æª”æ¡ˆä¸­ã€‚

**æŒ‡ä»¤ï¼š**

```bash
gemini mcp add [options] <name> <commandOrUrl> [args...]
```

- `<name>`ï¼šä¼ºæœå™¨çš„å”¯ä¸€åç¨±ã€‚
- `<commandOrUrl>`ï¼šè¦åŸ·è¡Œçš„æŒ‡ä»¤ï¼ˆé‡å° `stdio`ï¼‰æˆ– URLï¼ˆé‡å° `http`/`sse`ï¼‰ã€‚
- `[args...]`ï¼š`stdio` æŒ‡ä»¤çš„å¯é¸åƒæ•¸ã€‚

**é¸é …ï¼ˆæ——æ¨™ flagsï¼‰ï¼š**

- `-s, --scope`ï¼šè¨­å®šæª”ç¯„åœï¼ˆuser æˆ– projectï¼‰ã€‚[é è¨­å€¼ï¼š"project"]
- `-t, --transport`ï¼šå‚³è¼¸é¡å‹ï¼ˆstdioã€sseã€httpï¼‰ã€‚[é è¨­å€¼ï¼š"stdio"]
- `-e, --env`ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆä¾‹å¦‚ï¼š-e KEY=valueï¼‰ã€‚
- `-H, --header`ï¼šç‚º SSE å’Œ HTTP å‚³è¼¸è¨­å®š HTTP æ¨™é ­ï¼ˆä¾‹å¦‚ï¼š-H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`ï¼šè¨­å®šé€£ç·šé€¾æ™‚ï¼ˆæ¯«ç§’ï¼‰ã€‚
- `--trust`ï¼šä¿¡ä»»ä¼ºæœå™¨ï¼ˆç•¥éæ‰€æœ‰å·¥å…·å‘¼å«ç¢ºèªæç¤ºï¼‰ã€‚
- `--description`ï¼šè¨­å®šä¼ºæœå™¨æè¿°ã€‚
- `--include-tools`ï¼šè¦åŒ…å«çš„å·¥å…·ï¼Œä»¥é€—è™Ÿåˆ†éš”çš„æ¸…å–®ã€‚
- `--exclude-tools`ï¼šè¦æ’é™¤çš„å·¥å…·ï¼Œä»¥é€—è™Ÿåˆ†éš”çš„æ¸…å–®ã€‚

#### æ–°å¢ stdio ä¼ºæœå™¨

é€™æ˜¯åŸ·è¡Œæœ¬åœ°ä¼ºæœå™¨çš„é è¨­å‚³è¼¸æ–¹å¼ã€‚

```bash
# Basic syntax
gemini mcp add <name> <command> [args...]

# Example: Adding a local server
gemini mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# Example: Adding a local python server
gemini mcp add python-server python server.py --port 8080
```

#### æ–°å¢ HTTP ä¼ºæœå™¨

æ­¤å‚³è¼¸æ–¹å¼é©ç”¨æ–¼ä½¿ç”¨å¯ä¸²æµ HTTP å‚³è¼¸çš„ä¼ºæœå™¨ã€‚

```bash
# Basic syntax
gemini mcp add --transport http <name> <url>

# Example: Adding an HTTP server
gemini mcp add --transport http http-server https://api.example.com/mcp/

# Example: Adding an HTTP server with an authentication header
gemini mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### æ–°å¢ SSE ä¼ºæœå™¨

æ­¤å‚³è¼¸æ–¹å¼é©ç”¨æ–¼ä½¿ç”¨ Server-Sent Eventsï¼ˆSSEï¼‰çš„ä¼ºæœå™¨ã€‚

```bash
# Basic syntax
gemini mcp add --transport sse <name> <url>

# Example: Adding an SSE server
gemini mcp add --transport sse sse-server https://api.example.com/sse/

# Example: Adding an SSE server with an authentication header
gemini mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### åˆ—å‡ºä¼ºæœå™¨ (`gemini mcp list`)

è‹¥è¦æª¢è¦–ç›®å‰å·²è¨­å®šçš„æ‰€æœ‰ MCP ä¼ºæœå™¨ï¼Œè«‹ä½¿ç”¨ `list` æŒ‡ä»¤ã€‚æ­¤æŒ‡ä»¤æœƒé¡¯ç¤ºæ¯å€‹ä¼ºæœå™¨çš„åç¨±ã€çµ„æ…‹ç´°ç¯€ï¼Œä»¥åŠé€£ç·šç‹€æ…‹ã€‚

**æŒ‡ä»¤ï¼š**

```bash
gemini mcp list
```

**ç¯„ä¾‹è¼¸å‡ºï¼š**

```sh
âœ“ stdio-server: command: python3 server.py (stdio) - Connected
âœ“ http-server: https://api.example.com/mcp (http) - Connected
âœ— sse-server: https://api.example.com/sse (sse) - Disconnected
```

### ç§»é™¤ä¼ºæœå™¨ (`gemini mcp remove`)

è‹¥è¦å¾æ‚¨çš„è¨­å®šä¸­åˆªé™¤ä¸€å€‹ä¼ºæœå™¨ï¼Œè«‹ä½¿ç”¨ `remove` æŒ‡ä»¤ä¸¦æŒ‡å®šè©²ä¼ºæœå™¨çš„åç¨±ã€‚

**æŒ‡ä»¤ï¼š**

```bash
gemini mcp remove <name>
```

**ç¯„ä¾‹ï¼š**

```bash
gemini mcp remove my-server
```

é€™å°‡æ ¹æ“šç¯„åœï¼ˆ`-s, --scope`ï¼‰ï¼Œåœ¨ç›¸æ‡‰çš„ `settings.json` æª”æ¡ˆä¸­çš„ `mcpServers` ç‰©ä»¶è£¡ï¼Œæ‰¾åˆ°ä¸¦åˆªé™¤ "my-server" é …ç›®ã€‚
