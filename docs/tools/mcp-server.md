# é€é Gemini CLI ä½¿ç”¨ MCP ä¼ºæœå™¨

æœ¬æ–‡ä»¶æä¾›é€é Gemini CLI è¨­å®šå’Œä½¿ç”¨æ¨¡å‹å…§å®¹å”å®šï¼ˆMCPï¼‰ä¼ºæœå™¨çš„æŒ‡å—ã€‚

## ä»€éº¼æ˜¯ MCP ä¼ºæœå™¨ï¼Ÿ

MCP ä¼ºæœå™¨æ˜¯ä¸€å€‹æ‡‰ç”¨ç¨‹å¼ï¼Œé€éæ¨¡å‹å…§å®¹å”å®šå‘ Gemini CLI æš´éœ²å·¥å…·å’Œè³‡æºï¼Œå…è¨±å®ƒèˆ‡å¤–éƒ¨ç³»çµ±å’Œè³‡æ–™ä¾†æºäº’å‹•ã€‚MCP ä¼ºæœå™¨ä½œç‚º Gemini æ¨¡å‹èˆ‡æ‚¨çš„æœ¬åœ°ç’°å¢ƒæˆ–å…¶ä»–æœå‹™ï¼ˆå¦‚ APIï¼‰ä¹‹é–“çš„æ©‹æ¨‘ã€‚

MCP ä¼ºæœå™¨è®“ Gemini CLI èƒ½å¤ ï¼š

- **æ¢ç´¢å·¥å…·ï¼š** é€éæ¨™æº–åŒ–ç¶±è¦å®šç¾©åˆ—å‡ºå¯ç”¨å·¥å…·ã€å…¶èªªæ˜å’Œåƒæ•¸ã€‚
- **åŸ·è¡Œå·¥å…·ï¼š** ä½¿ç”¨å®šç¾©çš„å¼•æ•¸å‘¼å«ç‰¹å®šå·¥å…·ä¸¦æ¥æ”¶çµæ§‹åŒ–å›æ‡‰ã€‚
- **å­˜å–è³‡æºï¼š** å¾ç‰¹å®šè³‡æºè®€å–è³‡æ–™ï¼ˆé›–ç„¶ Gemini CLI ä¸»è¦å°ˆæ³¨æ–¼å·¥å…·åŸ·è¡Œï¼‰ã€‚

é€é MCP ä¼ºæœå™¨ï¼Œæ‚¨å¯ä»¥æ“´å±• Gemini CLI çš„èƒ½åŠ›ï¼ŒåŸ·è¡Œè¶…è¶Šå…¶å…§å»ºåŠŸèƒ½çš„å‹•ä½œï¼Œä¾‹å¦‚èˆ‡è³‡æ–™åº«ã€APIã€è‡ªè¨‚è…³æœ¬æˆ–å°ˆé–€å·¥ä½œæµç¨‹äº’å‹•ã€‚

## æ ¸å¿ƒæ•´åˆæ¶æ§‹

Gemini CLI é€éå»ºç«‹åœ¨æ ¸å¿ƒå¥—ä»¶ï¼ˆ`packages/core/src/tools/`ï¼‰ä¸­çš„è¤‡é›œæ¢ç´¢å’ŒåŸ·è¡Œç³»çµ±èˆ‡ MCP ä¼ºæœå™¨æ•´åˆï¼š

### æ¢ç´¢å±¤ï¼ˆ`mcp-client.ts`ï¼‰

æ¢ç´¢æµç¨‹ç”± `discoverMcpTools()` ç·¨æ’ï¼Œå®ƒï¼š

1. **éæ­·è¨­å®šçš„ä¼ºæœå™¨** å¾æ‚¨çš„ `settings.json` `mcpServers` è¨­å®š
2. **å»ºç«‹é€£ç·š** ä½¿ç”¨é©ç•¶çš„å‚³è¼¸æ©Ÿåˆ¶ï¼ˆStdioã€SSE æˆ– Streamable HTTPï¼‰
3. **å¾æ¯å€‹ä¼ºæœå™¨æ“·å–å·¥å…·å®šç¾©** ä½¿ç”¨ MCP å”å®š
4. **æ¸…ç†å’Œé©—è­‰** å·¥å…·ç¶±è¦ä»¥ç¢ºä¿èˆ‡ Gemini API çš„ç›¸å®¹æ€§
5. **åœ¨å…¨åŸŸå·¥å…·è¨»å†Šè¡¨ä¸­è¨»å†Šå·¥å…·** ä¸¦è§£æ±ºè¡çª

### åŸ·è¡Œå±¤ï¼ˆ`mcp-tool.ts`ï¼‰

æ¯å€‹è¢«æ¢ç´¢çš„ MCP å·¥å…·éƒ½è¢«åŒ…è£åœ¨ `DiscoveredMCPTool` å¯¦ä¾‹ä¸­ï¼Œå®ƒï¼š

- **è™•ç†ç¢ºèªé‚è¼¯** åŸºæ–¼ä¼ºæœå™¨ä¿¡ä»»è¨­å®šå’Œä½¿ç”¨è€…åå¥½
- **ç®¡ç†å·¥å…·åŸ·è¡Œ** é€éä½¿ç”¨é©ç•¶åƒæ•¸å‘¼å« MCP ä¼ºæœå™¨
- **è™•ç†å›æ‡‰** ç”¨æ–¼ LLM å…§å®¹å’Œä½¿ç”¨è€…é¡¯ç¤º
- **ç¶­è­·é€£ç·šç‹€æ…‹** ä¸¦è™•ç†é€¾æ™‚

### å‚³è¼¸æ©Ÿåˆ¶

Gemini CLI æ”¯æ´ä¸‰ç¨® MCP å‚³è¼¸é¡å‹ï¼š

- **Stdio å‚³è¼¸ï¼š** ç”¢ç”Ÿå­ç¨‹åºä¸¦é€é stdin/stdout é€šè¨Š
- **SSE å‚³è¼¸ï¼š** é€£ç·šåˆ°ä¼ºæœå™¨ç™¼é€äº‹ä»¶ç«¯é»
- **Streamable HTTP å‚³è¼¸ï¼š** ä½¿ç”¨ HTTP ä¸²æµé€²è¡Œé€šè¨Š

## å¦‚ä½•è¨­å®šæ‚¨çš„ MCP ä¼ºæœå™¨

Gemini CLI ä½¿ç”¨æ‚¨ `settings.json` æª”æ¡ˆä¸­çš„ `mcpServers` è¨­å®šä¾†å®šä½ä¸¦é€£ç·šåˆ° MCP ä¼ºæœå™¨ã€‚æ­¤è¨­å®šæ”¯æ´ä½¿ç”¨ä¸åŒå‚³è¼¸æ©Ÿåˆ¶çš„å¤šå€‹ä¼ºæœå™¨ã€‚

### åœ¨ settings.json ä¸­è¨­å®š MCP ä¼ºæœå™¨

æ‚¨å¯ä»¥åœ¨ `settings.json` æª”æ¡ˆä¸­ä»¥å…©ç¨®ä¸»è¦æ–¹å¼è¨­å®š MCP ä¼ºæœå™¨ï¼šé€éé ‚ç´š `mcpServers` ç‰©ä»¶é€²è¡Œç‰¹å®šä¼ºæœå™¨å®šç¾©ï¼Œä»¥åŠé€é `mcp` ç‰©ä»¶é€²è¡Œæ§åˆ¶ä¼ºæœå™¨æ¢ç´¢å’ŒåŸ·è¡Œçš„å…¨åŸŸè¨­å®šã€‚

#### å…¨åŸŸ MCP è¨­å®šï¼ˆ`mcp`ï¼‰

`settings.json` ä¸­çš„ `mcp` ç‰©ä»¶å…è¨±æ‚¨ç‚ºæ‰€æœ‰ MCP ä¼ºæœå™¨å®šç¾©å…¨åŸŸè¦å‰‡ã€‚

- **`mcp.serverCommand`**ï¼ˆå­—ä¸²ï¼‰ï¼šå•Ÿå‹• MCP ä¼ºæœå™¨çš„å…¨åŸŸæŒ‡ä»¤ã€‚
- **`mcp.allowed`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šå…è¨±çš„ MCP ä¼ºæœå™¨åç¨±ç™½åå–®ã€‚å¦‚æœè¨­å®šäº†æ­¤é …ï¼Œåªæœ‰ä¾†è‡ªæ­¤æ¸…å–®çš„ä¼ºæœå™¨ï¼ˆç¬¦åˆ `mcpServers` ç‰©ä»¶ä¸­çš„é‡‘é‘°ï¼‰æ‰æœƒè¢«é€£ç·šã€‚
- **`mcp.excluded`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šè¦æ’é™¤çš„ MCP ä¼ºæœå™¨åç¨±é»‘åå–®ã€‚æ­¤æ¸…å–®ä¸­çš„ä¼ºæœå™¨å°‡ä¸æœƒè¢«é€£ç·šã€‚

**ç¯„ä¾‹ï¼š**

```json
{
  "mcp": {
    "allowed": ["my-trusted-server"],
    "excluded": ["experimental-server"]
  }
}
```

#### ä¼ºæœå™¨ç‰¹å®šè¨­å®šï¼ˆ`mcpServers`ï¼‰

`mcpServers` ç‰©ä»¶æ˜¯æ‚¨å®šç¾©å¸Œæœ› CLI é€£ç·šçš„æ¯å€‹å€‹åˆ¥ MCP ä¼ºæœå™¨çš„åœ°æ–¹ã€‚

### è¨­å®šçµæ§‹

å°‡ `mcpServers` ç‰©ä»¶æ–°å¢åˆ°æ‚¨çš„ `settings.json` æª”æ¡ˆï¼š

```json
{ ...æª”æ¡ˆåŒ…å«å…¶ä»–è¨­å®šç‰©ä»¶
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### è¨­å®šå±¬æ€§

æ¯å€‹ä¼ºæœå™¨è¨­å®šæ”¯æ´ä»¥ä¸‹å±¬æ€§ï¼š

#### å¿…è¦ï¼ˆä»¥ä¸‹å…¶ä¸­ä¸€é …ï¼‰

- **`command`**ï¼ˆå­—ä¸²ï¼‰ï¼šStdio å‚³è¼¸çš„å¯åŸ·è¡Œæª”è·¯å¾‘
- **`url`**ï¼ˆå­—ä¸²ï¼‰ï¼šSSE ç«¯é» URLï¼ˆä¾‹å¦‚ï¼Œ`"http://localhost:8080/sse"`ï¼‰
- **`httpUrl`**ï¼ˆå­—ä¸²ï¼‰ï¼šHTTP ä¸²æµç«¯é» URL

#### é¸ç”¨

- **`args`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šStdio å‚³è¼¸çš„å‘½ä»¤åˆ—å¼•æ•¸
- **`headers`**ï¼ˆç‰©ä»¶ï¼‰ï¼šä½¿ç”¨ `url` æˆ– `httpUrl` æ™‚çš„è‡ªè¨‚ HTTP æ¨™é ­
- **`env`**ï¼ˆç‰©ä»¶ï¼‰ï¼šä¼ºæœå™¨ç¨‹åºçš„ç’°å¢ƒè®Šæ•¸ã€‚å€¼å¯ä»¥ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` èªæ³•åƒè€ƒç’°å¢ƒè®Šæ•¸
- **`cwd`**ï¼ˆå­—ä¸²ï¼‰ï¼šStdio å‚³è¼¸çš„å·¥ä½œç›®éŒ„
- **`timeout`**ï¼ˆæ•¸å­—ï¼‰ï¼šè«‹æ±‚é€¾æ™‚æ¯«ç§’æ•¸ï¼ˆé è¨­ï¼š600,000ms = 10 åˆ†é˜ï¼‰
- **`trust`**ï¼ˆå¸ƒæ—å€¼ï¼‰ï¼šç•¶ç‚º `true` æ™‚ï¼Œæœƒç•¥éæ­¤ä¼ºæœå™¨çš„æ‰€æœ‰å·¥å…·å‘¼å«ç¢ºèªï¼ˆé è¨­ï¼š`false`ï¼‰
- **`includeTools`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šå¾æ­¤ MCP ä¼ºæœå™¨åŒ…å«çš„å·¥å…·åç¨±æ¸…å–®ã€‚æŒ‡å®šæ™‚ï¼Œåªæœ‰æ­¤è™•åˆ—å‡ºçš„å·¥å…·æ‰æœƒå¾æ­¤ä¼ºæœå™¨å¯ç”¨ï¼ˆç™½åå–®è¡Œç‚ºï¼‰ã€‚å¦‚æœæœªæŒ‡å®šï¼Œé è¨­å•Ÿç”¨ä¾†è‡ªä¼ºæœå™¨çš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šå¾æ­¤ MCP ä¼ºæœå™¨æ’é™¤çš„å·¥å…·åç¨±æ¸…å–®ã€‚æ­¤è™•åˆ—å‡ºçš„å·¥å…·å°‡ä¸æœƒæä¾›çµ¦æ¨¡å‹ï¼Œå³ä½¿å®ƒå€‘ç”±ä¼ºæœå™¨æš´éœ²ã€‚**æ³¨æ„ï¼š** `excludeTools` å„ªå…ˆæ–¼ `includeTools` - å¦‚æœå·¥å…·åœ¨å…©å€‹æ¸…å–®ä¸­ï¼Œå®ƒå°‡è¢«æ’é™¤ã€‚

### é ç«¯ MCP ä¼ºæœå™¨çš„ OAuth æ”¯æ´

Gemini CLI æ”¯æ´ä½¿ç”¨ SSE æˆ– HTTP å‚³è¼¸çš„é ç«¯ MCP ä¼ºæœå™¨çš„ OAuth 2.0 é©—è­‰ã€‚é€™ä½¿å¾—éœ€è¦é©—è­‰çš„ MCP ä¼ºæœå™¨èƒ½å¤ å®‰å…¨å­˜å–ã€‚

#### è‡ªå‹• OAuth æ¢ç´¢

å°æ–¼æ”¯æ´ OAuth æ¢ç´¢çš„ä¼ºæœå™¨ï¼Œæ‚¨å¯ä»¥çœç•¥ OAuth è¨­å®šä¸¦è®“ CLI è‡ªå‹•æ¢ç´¢ï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

CLI æœƒè‡ªå‹•ï¼š

- åµæ¸¬ä¼ºæœå™¨ä½•æ™‚éœ€è¦ OAuth é©—è­‰ï¼ˆ401 å›æ‡‰ï¼‰
- å¾ä¼ºæœå™¨ä¸­ç¹¼è³‡æ–™æ¢ç´¢ OAuth ç«¯é»
- å¦‚æœæ”¯æ´ï¼ŒåŸ·è¡Œå‹•æ…‹ç”¨æˆ¶ç«¯è¨»å†Š
- è™•ç† OAuth æµç¨‹å’Œæ¬Šæ–ç®¡ç†

#### é©—è­‰æµç¨‹

é€£ç·šåˆ°å•Ÿç”¨ OAuth çš„ä¼ºæœå™¨æ™‚ï¼š

1. **åˆå§‹é€£ç·šå˜—è©¦**å›  401 æœªæˆæ¬Šå¤±æ•—
2. **OAuth æ¢ç´¢**æ‰¾åˆ°æˆæ¬Šå’Œæ¬Šæ–ç«¯é»
3. **ç€è¦½å™¨é–‹å•Ÿ**ä¾›ä½¿ç”¨è€…é©—è­‰ï¼ˆéœ€è¦æœ¬æ©Ÿç€è¦½å™¨å­˜å–ï¼‰
4. **æˆæ¬Šä»£ç¢¼**äº¤æ›å­˜å–æ¬Šæ–
5. **æ¬Šæ–è¢«å®‰å…¨å„²å­˜**ä¾›æœªä¾†ä½¿ç”¨
6. **é€£ç·šé‡è©¦**ä»¥æœ‰æ•ˆæ¬Šæ–æˆåŠŸ

#### ç€è¦½å™¨é‡æ–°å°å‘éœ€æ±‚

**é‡è¦ï¼š** OAuth é©—è­‰éœ€è¦æ‚¨çš„æœ¬æ©Ÿæ©Ÿå™¨èƒ½å¤ ï¼š

- é–‹å•Ÿç¶²é ç€è¦½å™¨é€²è¡Œé©—è­‰
- åœ¨ `http://localhost:7777/oauth/callback` æ¥æ”¶é‡æ–°å°å‘

æ­¤åŠŸèƒ½åœ¨ä»¥ä¸‹æƒ…æ³ä¸‹ç„¡æ³•é‹ä½œï¼š

- æ²’æœ‰ç€è¦½å™¨å­˜å–çš„ç„¡é ­ç’°å¢ƒ
- æ²’æœ‰ X11 è½‰é€çš„é ç«¯ SSH å·¥ä½œéšæ®µ
- æ²’æœ‰ç€è¦½å™¨æ”¯æ´çš„å®¹å™¨åŒ–ç’°å¢ƒ

#### ç®¡ç† OAuth é©—è­‰

ä½¿ç”¨ `/mcp auth` æŒ‡ä»¤ç®¡ç† OAuth é©—è­‰ï¼š

```bash
# åˆ—å‡ºéœ€è¦é©—è­‰çš„ä¼ºæœå™¨
/mcp auth

# èˆ‡ç‰¹å®šä¼ºæœå™¨é€²è¡Œé©—è­‰
/mcp auth serverName

# æ¬Šæ–éæœŸæ™‚é‡æ–°é©—è­‰
/mcp auth serverName
```

#### OAuth è¨­å®šå±¬æ€§

- **`enabled`**ï¼ˆå¸ƒæ—å€¼ï¼‰ï¼šç‚ºæ­¤ä¼ºæœå™¨å•Ÿç”¨ OAuth
- **`clientId`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth ç”¨æˆ¶ç«¯è­˜åˆ¥ç¢¼ï¼ˆå‹•æ…‹è¨»å†Šæ™‚ç‚ºé¸ç”¨ï¼‰
- **`clientSecret`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth ç”¨æˆ¶ç«¯å¯†é‘°ï¼ˆå…¬é–‹ç”¨æˆ¶ç«¯ç‚ºé¸ç”¨ï¼‰
- **`authorizationUrl`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth æˆæ¬Šç«¯é»ï¼ˆçœç•¥æ™‚è‡ªå‹•æ¢ç´¢ï¼‰
- **`tokenUrl`**ï¼ˆå­—ä¸²ï¼‰ï¼šOAuth æ¬Šæ–ç«¯é»ï¼ˆçœç•¥æ™‚è‡ªå‹•æ¢ç´¢ï¼‰
- **`scopes`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šæ‰€éœ€çš„ OAuth ç¯„åœ
- **`redirectUri`**ï¼ˆå­—ä¸²ï¼‰ï¼šè‡ªè¨‚é‡æ–°å°å‘ URIï¼ˆé è¨­ç‚º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`**ï¼ˆå­—ä¸²ï¼‰ï¼šSSE URL ä¸­æ¬Šæ–çš„æŸ¥è©¢åƒæ•¸åç¨±
- **`audiences`**ï¼ˆå­—ä¸²é™£åˆ—ï¼‰ï¼šæ¬Šæ–æœ‰æ•ˆçš„ç›®æ¨™å°è±¡

#### æ¬Šæ–ç®¡ç†

OAuth æ¬Šæ–æœƒè‡ªå‹•ï¼š

- **å®‰å…¨å„²å­˜**æ–¼ `~/.gemini/mcp-oauth-tokens.json`
- **é‡æ–°æ•´ç†**éæœŸæ¬Šæ–ï¼ˆå¦‚æœæœ‰é‡æ–°æ•´ç†æ¬Šæ–å¯ç”¨ï¼‰
- **é©—è­‰**æ¯æ¬¡é€£ç·šå˜—è©¦å‰
- **æ¸…ç†**ç„¡æ•ˆæˆ–éæœŸçš„æ¬Šæ–

#### é©—è­‰æä¾›è€…é¡å‹

æ‚¨å¯ä»¥ä½¿ç”¨ `authProviderType` å±¬æ€§æŒ‡å®šé©—è­‰æä¾›è€…é¡å‹ï¼š

- **`authProviderType`**ï¼ˆå­—ä¸²ï¼‰ï¼šæŒ‡å®šé©—è­‰æä¾›è€…ã€‚å¯ä»¥æ˜¯ä»¥ä¸‹å…¶ä¸­ä¸€é …ï¼š
  - **`dynamic_discovery`**ï¼ˆé è¨­ï¼‰ï¼šCLI æœƒè‡ªå‹•å¾ä¼ºæœå™¨æ¢ç´¢ OAuth è¨­å®šã€‚
  - **`google_credentials`**ï¼šCLI æœƒä½¿ç”¨ Google æ‡‰ç”¨ç¨‹å¼é è¨­æ†‘è­‰ï¼ˆADCï¼‰èˆ‡ä¼ºæœå™¨é€²è¡Œé©—è­‰ã€‚ä½¿ç”¨æ­¤æä¾›è€…æ™‚ï¼Œæ‚¨å¿…é ˆæŒ‡å®šæ‰€éœ€çš„ç¯„åœã€‚

```json
{
  "mcpServers": {
    "googleCloudServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "google_credentials",
      "oauth": {
        "scopes": ["https://www.googleapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

### è¨­å®šç¯„ä¾‹

#### Python MCP ä¼ºæœå™¨ï¼ˆStdioï¼‰

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP ä¼ºæœå™¨ï¼ˆStdioï¼‰

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºæ–¼ Docker çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºæ–¼ HTTP çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### å¸¶æœ‰è‡ªè¨‚æ¨™é ­çš„åŸºæ–¼ HTTP çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å¸¶æœ‰å·¥å…·ç¯©é¸çš„ MCP ä¼ºæœå™¨

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

## æ¢ç´¢æµç¨‹æ·±å…¥è§£æ

ç•¶ Gemini CLI å•Ÿå‹•æ™‚ï¼Œå®ƒé€éä»¥ä¸‹è©³ç´°æµç¨‹åŸ·è¡Œ MCP ä¼ºæœå™¨æ¢ç´¢ï¼š

### 1. ä¼ºæœå™¨è¿­ä»£èˆ‡é€£ç·š

å°æ–¼ `mcpServers` ä¸­æ¯å€‹è¨­å®šçš„ä¼ºæœå™¨ï¼š

1. **ç‹€æ…‹è¿½è¹¤é–‹å§‹ï¼š** ä¼ºæœå™¨ç‹€æ…‹è¨­å®šç‚º `CONNECTING`
2. **å‚³è¼¸é¸æ“‡ï¼š** åŸºæ–¼è¨­å®šå±¬æ€§ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **å»ºç«‹é€£ç·šï¼š** MCP ç”¨æˆ¶ç«¯å˜—è©¦ä½¿ç”¨è¨­å®šçš„é€¾æ™‚æ™‚é–“é€£ç·š
4. **éŒ¯èª¤è™•ç†ï¼š** é€£ç·šå¤±æ•—æœƒè¢«è¨˜éŒ„ï¼Œä¼ºæœå™¨ç‹€æ…‹è¨­å®šç‚º `DISCONNECTED`

### 2. å·¥å…·æ¢ç´¢

æˆåŠŸé€£ç·šå¾Œï¼š

1. **å·¥å…·æ¸…å–®ï¼š** ç”¨æˆ¶ç«¯å‘¼å« MCP ä¼ºæœå™¨çš„å·¥å…·æ¸…å–®ç«¯é»
2. **ç¶±è¦é©—è­‰ï¼š** æ¯å€‹å·¥å…·çš„å‡½å¼å®£å‘Šéƒ½æœƒè¢«é©—è­‰
3. **å·¥å…·ç¯©é¸ï¼š** å·¥å…·æœƒæ ¹æ“š `includeTools` å’Œ `excludeTools` è¨­å®šé€²è¡Œç¯©é¸
4. **åç¨±æ·¨åŒ–ï¼š** å·¥å…·åç¨±æœƒè¢«æ¸…ç†ä»¥ç¬¦åˆ Gemini API è¦æ±‚ï¼š
   - ç„¡æ•ˆå­—å…ƒï¼ˆéè‹±æ•¸å­—ã€åº•ç·šã€é»ã€é€£å­—è™Ÿï¼‰æœƒè¢«æ›¿æ›ç‚ºåº•ç·š
   - è¶…é 63 å­—å…ƒçš„åç¨±æœƒè¢«æˆªæ–·ä¸¦é€²è¡Œä¸­é–“æ›¿æ›ï¼ˆ`___`ï¼‰

### 3. è¡çªè§£æ±º

ç•¶å¤šå€‹ä¼ºæœå™¨æš´éœ²åŒåå·¥å…·æ™‚ï¼š

1. **é¦–æ¬¡è¨»å†Šç²å‹ï¼š** ç¬¬ä¸€å€‹è¨»å†Šå·¥å…·åç¨±çš„ä¼ºæœå™¨å–å¾—ç„¡å‰ç¶´åç¨±
2. **è‡ªå‹•åŠ å‰ç¶´ï¼š** å¾ŒçºŒä¼ºæœå™¨å–å¾—åŠ å‰ç¶´çš„åç¨±ï¼š`serverName__toolName`
3. **è¨»å†Šè¡¨è¿½è¹¤ï¼š** å·¥å…·è¨»å†Šè¡¨ç¶­è­·ä¼ºæœå™¨åç¨±èˆ‡å…¶å·¥å…·ä¹‹é–“çš„å°æ‡‰

### 4. ç¶±è¦è™•ç†

å·¥å…·åƒæ•¸ç¶±è¦æœƒç¶“éæ·¨åŒ–ä»¥ç¬¦åˆ Gemini API ç›¸å®¹æ€§ï¼š

- **`$schema` å±¬æ€§**æœƒè¢«ç§»é™¤
- **`additionalProperties`**æœƒè¢«å‰é›¢
- **å¸¶æœ‰ `default` çš„ `anyOf`**æœƒç§»é™¤å…¶é è¨­å€¼ï¼ˆVertex AI ç›¸å®¹æ€§ï¼‰
- **éè¿´è™•ç†**å¥—ç”¨æ–¼å·¢ç‹€ç¶±è¦

### 5. é€£ç·šç®¡ç†

æ¢ç´¢å¾Œï¼š

- **æŒä¹…é€£ç·šï¼š** æˆåŠŸè¨»å†Šå·¥å…·çš„ä¼ºæœå™¨æœƒç¶­æŒå…¶é€£ç·š
- **æ¸…ç†ï¼š** ä¸æä¾›å¯ç”¨å·¥å…·çš„ä¼ºæœå™¨æœƒé—œé–‰å…¶é€£ç·š
- **ç‹€æ…‹æ›´æ–°ï¼š** æœ€çµ‚ä¼ºæœå™¨ç‹€æ…‹è¨­å®šç‚º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·åŸ·è¡Œæµç¨‹

ç•¶ Gemini æ¨¡å‹æ±ºå®šä½¿ç”¨ MCP å·¥å…·æ™‚ï¼Œæœƒç™¼ç”Ÿä»¥ä¸‹åŸ·è¡Œæµç¨‹ï¼š

### 1. å·¥å…·å‘¼å«

æ¨¡å‹æœƒç”¢ç”Ÿä¸€å€‹ `FunctionCall`ï¼ŒåŒ…å«ï¼š

- **å·¥å…·åç¨±ï¼š** è¨»å†Šçš„åç¨±ï¼ˆå¯èƒ½å¸¶æœ‰å‰ç¶´ï¼‰
- **å¼•æ•¸ï¼š** ç¬¦åˆå·¥å…·åƒæ•¸ç¶±è¦çš„ JSON ç‰©ä»¶

### 2. ç¢ºèªæµç¨‹

æ¯å€‹ `DiscoveredMCPTool` å¯¦ä½œè¤‡é›œçš„ç¢ºèªé‚è¼¯ï¼š

#### åŸºæ–¼ä¿¡ä»»çš„ç•¥é

```typescript
if (this.trust) {
  return false; // ä¸éœ€è¦ç¢ºèª
}
```

#### å‹•æ…‹å…è¨±æ¸…å–®

ç³»çµ±ç¶­è­·ä»¥ä¸‹å…§éƒ¨å…è¨±æ¸…å–®ï¼š

- **ä¼ºæœå™¨å±¤ç´šï¼š** `serverName` â†’ æ­¤ä¼ºæœå™¨çš„æ‰€æœ‰å·¥å…·éƒ½å—ä¿¡ä»»
- **å·¥å…·å±¤ç´šï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·å—ä¿¡ä»»

#### ä½¿ç”¨è€…é¸æ“‡è™•ç†

ç•¶éœ€è¦ç¢ºèªæ™‚ï¼Œä½¿ç”¨è€…å¯ä»¥é¸æ“‡ï¼š

- **åƒ…æ­¤æ¬¡åŸ·è¡Œï¼š** åƒ…åŸ·è¡Œé€™æ¬¡
- **ç¸½æ˜¯å…è¨±æ­¤å·¥å…·ï¼š** æ–°å¢åˆ°å·¥å…·å±¤ç´šå…è¨±æ¸…å–®
- **ç¸½æ˜¯å…è¨±æ­¤ä¼ºæœå™¨ï¼š** æ–°å¢åˆ°ä¼ºæœå™¨å±¤ç´šå…è¨±æ¸…å–®
- **å–æ¶ˆï¼š** ä¸­æ­¢åŸ·è¡Œ

### 3. åŸ·è¡Œ

ç¢ºèªå¾Œï¼ˆæˆ–ä¿¡ä»»ç•¥éï¼‰ï¼š

1. **åƒæ•¸æº–å‚™ï¼š** å¼•æ•¸æœƒæ ¹æ“šå·¥å…·ç¶±è¦é€²è¡Œé©—è­‰
2. **MCP å‘¼å«ï¼š** åº•å±¤ `CallableTool` æœƒä½¿ç”¨ä»¥ä¸‹åƒæ•¸å‘¼å«ä¼ºæœå™¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // åŸå§‹ä¼ºæœå™¨å·¥å…·åç¨±
       args: params,
     },
   ];
   ```

3. **å›æ‡‰è™•ç†ï¼š** çµæœæœƒæ ¼å¼åŒ–ä¾› LLM å…§å®¹å’Œä½¿ç”¨è€…é¡¯ç¤ºä½¿ç”¨

### 4. å›æ‡‰è™•ç†

åŸ·è¡ŒçµæœåŒ…å«ï¼š

- **`llmContent`ï¼š** ä¾›èªè¨€æ¨¡å‹å…§å®¹ä½¿ç”¨çš„åŸå§‹å›æ‡‰éƒ¨åˆ†
- **`returnDisplay`ï¼š** ä¾›ä½¿ç”¨è€…é¡¯ç¤ºä½¿ç”¨çš„æ ¼å¼åŒ–è¼¸å‡ºï¼ˆé€šå¸¸æ˜¯ markdown ç¨‹å¼ç¢¼å€å¡Šä¸­çš„ JSONï¼‰

## å¦‚ä½•èˆ‡æ‚¨çš„ MCP ä¼ºæœå™¨äº’å‹•

### ä½¿ç”¨ `/mcp` æŒ‡ä»¤

`/mcp` æŒ‡ä»¤æä¾›é—œæ–¼æ‚¨ MCP ä¼ºæœå™¨è¨­å®šçš„å®Œæ•´è³‡è¨Šï¼š

```bash
/mcp
```

é€™æœƒé¡¯ç¤ºï¼š

- **ä¼ºæœå™¨æ¸…å–®ï¼š** æ‰€æœ‰è¨­å®šçš„ MCP ä¼ºæœå™¨
- **é€£ç·šç‹€æ…‹ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **ä¼ºæœå™¨è©³ç´°è³‡æ–™ï¼š** è¨­å®šæ‘˜è¦ï¼ˆæ’é™¤æ•æ„Ÿè³‡æ–™ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** ä¾†è‡ªæ¯å€‹ä¼ºæœå™¨çš„å·¥å…·æ¸…å–®åŠèªªæ˜
- **æ¢ç´¢ç‹€æ…‹ï¼š** æ•´é«”æ¢ç´¢æµç¨‹ç‹€æ…‹

### `/mcp` è¼¸å‡ºç¯„ä¾‹

```
MCP ä¼ºæœå™¨ç‹€æ…‹ï¼š

ğŸ“¡ pythonTools (å·²é€£ç·š)
  æŒ‡ä»¤ï¼špython -m my_mcp_server --port 8080
  å·¥ä½œç›®éŒ„ï¼š./mcp-servers/python
  é€¾æ™‚ï¼š15000ms
  å·¥å…·ï¼šcalculate_sumã€file_analyzerã€data_processor

ğŸ”Œ nodeServer (å·²ä¸­æ–·é€£ç·š)
  æŒ‡ä»¤ï¼šnode dist/server.js --verbose
  éŒ¯èª¤ï¼šé€£ç·šè¢«æ‹’çµ•

ğŸ³ dockerizedServer (å·²é€£ç·š)
  æŒ‡ä»¤ï¼šdocker run -i --rm -e API_KEY my-mcp-server:latest
  å·¥å…·ï¼šdocker__deployã€docker__status

æ¢ç´¢ç‹€æ…‹ï¼šå·²å®Œæˆ
```

### å·¥å…·ä½¿ç”¨

ä¸€æ—¦è¢«æ¢ç´¢ï¼ŒMCP å·¥å…·å°±åƒå…§å»ºå·¥å…·ä¸€æ¨£å¯ä¾› Gemini æ¨¡å‹ä½¿ç”¨ã€‚æ¨¡å‹æœƒè‡ªå‹•ï¼š

1. **é¸æ“‡é©ç•¶çš„å·¥å…·**åŸºæ–¼æ‚¨çš„è«‹æ±‚
2. **é¡¯ç¤ºç¢ºèªå°è©±æ–¹å¡Š**ï¼ˆé™¤éä¼ºæœå™¨å—ä¿¡ä»»ï¼‰
3. **åŸ·è¡Œå·¥å…·**ä½¿ç”¨é©ç•¶çš„åƒæ•¸
4. **é¡¯ç¤ºçµæœ**ä»¥ä½¿ç”¨è€…å‹å–„çš„æ ¼å¼

## ç‹€æ…‹ç›£æ§èˆ‡ç–‘é›£æ’è§£

### é€£ç·šç‹€æ…‹

MCP æ•´åˆæœƒè¿½è¹¤æ•¸å€‹ç‹€æ…‹ï¼š

#### ä¼ºæœå™¨ç‹€æ…‹ï¼ˆ`MCPServerStatus`ï¼‰

- **`DISCONNECTED`ï¼š** ä¼ºæœå™¨æœªé€£ç·šæˆ–æœ‰éŒ¯èª¤
- **`CONNECTING`ï¼š** é€£ç·šå˜—è©¦é€²è¡Œä¸­
- **`CONNECTED`ï¼š** ä¼ºæœå™¨å·²é€£ç·šä¸”å°±ç·’

#### æ¢ç´¢ç‹€æ…‹ï¼ˆ`MCPDiscoveryState`ï¼‰

- **`NOT_STARTED`ï¼š** æ¢ç´¢å°šæœªé–‹å§‹
- **`IN_PROGRESS`ï¼š** ç›®å‰æ­£åœ¨æ¢ç´¢ä¼ºæœå™¨
- **`COMPLETED`ï¼š** æ¢ç´¢å·²å®Œæˆï¼ˆç„¡è«–æ˜¯å¦æœ‰éŒ¯èª¤ï¼‰

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

#### ä¼ºæœå™¨ç„¡æ³•é€£ç·š

**ç—‡ç‹€ï¼š** ä¼ºæœå™¨é¡¯ç¤º `DISCONNECTED` ç‹€æ…‹

**ç–‘é›£æ’è§£ï¼š**

1. **æª¢æŸ¥è¨­å®šï¼š** é©—è­‰ `command`ã€`args` å’Œ `cwd` æ˜¯å¦æ­£ç¢º
2. **æ‰‹å‹•æ¸¬è©¦ï¼š** ç›´æ¥åŸ·è¡Œä¼ºæœå™¨æŒ‡ä»¤ä»¥ç¢ºä¿å®ƒèƒ½é‹ä½œ
3. **æª¢æŸ¥ç›¸ä¾æ€§ï¼š** ç¢ºä¿æ‰€æœ‰å¿…è¦çš„å¥—ä»¶éƒ½å·²å®‰è£
4. **æŸ¥çœ‹æ—¥èªŒï¼š** åœ¨ CLI è¼¸å‡ºä¸­å°‹æ‰¾éŒ¯èª¤è¨Šæ¯
5. **é©—è­‰æ¬Šé™ï¼š** ç¢ºä¿ CLI å¯ä»¥åŸ·è¡Œä¼ºæœå™¨æŒ‡ä»¤

#### æ²’æœ‰æ¢ç´¢åˆ°å·¥å…·

**ç—‡ç‹€ï¼š** ä¼ºæœå™¨é€£ç·šä½†æ²’æœ‰å¯ç”¨å·¥å…·

**ç–‘é›£æ’è§£ï¼š**

1. **é©—è­‰å·¥å…·è¨»å†Šï¼š** ç¢ºä¿æ‚¨çš„ä¼ºæœå™¨å¯¦éš›ä¸Šæœ‰è¨»å†Šå·¥å…·
2. **æª¢æŸ¥ MCP å”å®šï¼š** ç¢ºèªæ‚¨çš„ä¼ºæœå™¨æ­£ç¢ºå¯¦ä½œ MCP å·¥å…·æ¸…å–®
3. **æŸ¥çœ‹ä¼ºæœå™¨æ—¥èªŒï¼š** æª¢æŸ¥ stderr è¼¸å‡ºä¸­çš„ä¼ºæœå™¨ç«¯éŒ¯èª¤
4. **æ¸¬è©¦å·¥å…·æ¸…å–®ï¼š** æ‰‹å‹•æ¸¬è©¦æ‚¨ä¼ºæœå™¨çš„å·¥å…·æ¢ç´¢ç«¯é»

#### å·¥å…·ç„¡æ³•åŸ·è¡Œ

**ç—‡ç‹€ï¼š** å·¥å…·è¢«æ¢ç´¢åˆ°ä½†åœ¨åŸ·è¡Œæ™‚å¤±æ•—

**ç–‘é›£æ’è§£ï¼š**

1. **åƒæ•¸é©—è­‰ï¼š** ç¢ºä¿æ‚¨çš„å·¥å…·æ¥å—é æœŸçš„åƒæ•¸
2. **ç¶±è¦ç›¸å®¹æ€§ï¼š** é©—è­‰æ‚¨çš„è¼¸å…¥ç¶±è¦æ˜¯æœ‰æ•ˆçš„ JSON ç¶±è¦
3. **éŒ¯èª¤è™•ç†ï¼š** æª¢æŸ¥æ‚¨çš„å·¥å…·æ˜¯å¦ä¸Ÿå‡ºæœªè™•ç†çš„ä¾‹å¤–
4. **é€¾æ™‚å•é¡Œï¼š** è€ƒæ…®å¢åŠ  `timeout` è¨­å®š

#### æ²™ç®±ç›¸å®¹æ€§

**ç—‡ç‹€ï¼š** å•Ÿç”¨æ²™ç®±åŒ–æ™‚ MCP ä¼ºæœå™¨å¤±æ•—

**è§£æ±ºæ–¹æ¡ˆï¼š**

1. **åŸºæ–¼ Docker çš„ä¼ºæœå™¨ï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ç›¸ä¾æ€§çš„ Docker å®¹å™¨
2. **è·¯å¾‘å¯å­˜å–æ€§ï¼š** ç¢ºä¿ä¼ºæœå™¨å¯åŸ·è¡Œæª”åœ¨æ²™ç®±ä¸­å¯ç”¨
3. **ç¶²è·¯å­˜å–ï¼š** è¨­å®šæ²™ç®±ä»¥å…è¨±å¿…è¦çš„ç¶²è·¯é€£ç·š
4. **ç’°å¢ƒè®Šæ•¸ï¼š** é©—è­‰æ‰€éœ€çš„ç’°å¢ƒè®Šæ•¸æœ‰è¢«å‚³é

### åµéŒ¯æŠ€å·§

1. **å•Ÿç”¨åµéŒ¯æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` åŸ·è¡Œ CLI ä»¥å–å¾—è©³ç´°è¼¸å‡º
2. **æª¢æŸ¥ stderrï¼š** MCP ä¼ºæœå™¨ stderr æœƒè¢«æ“·å–ä¸¦è¨˜éŒ„ï¼ˆINFO è¨Šæ¯å·²ç¯©é¸ï¼‰
3. **æ¸¬è©¦éš”é›¢ï¼š** åœ¨æ•´åˆå‰ç¨ç«‹æ¸¬è©¦æ‚¨çš„ MCP ä¼ºæœå™¨
4. **å¢é‡è¨­å®šï¼š** åœ¨æ–°å¢è¤‡é›œåŠŸèƒ½å‰å…ˆå¾ç°¡å–®å·¥å…·é–‹å§‹
5. **ç¶“å¸¸ä½¿ç”¨ `/mcp`ï¼š** åœ¨é–‹ç™¼æœŸé–“ç›£æ§ä¼ºæœå™¨ç‹€æ…‹

## é‡è¦æ³¨æ„äº‹é …

### å®‰å…¨æ€§è€ƒé‡

- **ä¿¡ä»»è¨­å®šï¼š** `trust` é¸é …æœƒç•¥éæ‰€æœ‰ç¢ºèªå°è©±æ–¹å¡Šã€‚è«‹è¬¹æ…ä½¿ç”¨ï¼Œåƒ…ç”¨æ–¼æ‚¨å®Œå…¨æ§åˆ¶çš„ä¼ºæœå™¨
- **å­˜å–æ¬Šæ–ï¼š** è¨­å®šåŒ…å« API é‡‘é‘°æˆ–æ¬Šæ–çš„ç’°å¢ƒè®Šæ•¸æ™‚è¦æ³¨æ„å®‰å…¨æ€§
- **æ²™ç®±ç›¸å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç®±åŒ–æ™‚ï¼Œç¢ºä¿ MCP ä¼ºæœå™¨åœ¨æ²™ç®±ç’°å¢ƒä¸­å¯ç”¨
- **ç§äººè³‡æ–™ï¼š** ä½¿ç”¨ç¯„åœå»£æ³›çš„å€‹äººå­˜å–æ¬Šæ–å¯èƒ½å°è‡´å„²å­˜åº«é–“çš„è³‡è¨Šæ´©æ¼

### æ•ˆèƒ½èˆ‡è³‡æºç®¡ç†

- **é€£ç·šæŒä¹…æ€§ï¼š** CLI æœƒç¶­æŒèˆ‡æˆåŠŸè¨»å†Šå·¥å…·çš„ä¼ºæœå™¨çš„æŒä¹…é€£ç·š
- **è‡ªå‹•æ¸…ç†ï¼š** èˆ‡ä¸æä¾›å·¥å…·çš„ä¼ºæœå™¨çš„é€£ç·šæœƒè‡ªå‹•é—œé–‰
- **é€¾æ™‚ç®¡ç†ï¼š** æ ¹æ“šæ‚¨ä¼ºæœå™¨çš„å›æ‡‰ç‰¹æ€§è¨­å®šé©ç•¶çš„é€¾æ™‚
- **è³‡æºç›£æ§ï¼š** MCP ä¼ºæœå™¨ä½œç‚ºç¨ç«‹ç¨‹åºåŸ·è¡Œä¸¦æ¶ˆè€—ç³»çµ±è³‡æº

### ç¶±è¦ç›¸å®¹æ€§

- **å±¬æ€§å‰é›¢ï¼š** ç³»çµ±æœƒè‡ªå‹•ç§»é™¤æŸäº›ç¶±è¦å±¬æ€§ï¼ˆ`$schema`ã€`additionalProperties`ï¼‰ä»¥ç¬¦åˆ Gemini API ç›¸å®¹æ€§
- **åç¨±æ·¨åŒ–ï¼š** å·¥å…·åç¨±æœƒè‡ªå‹•æ·¨åŒ–ä»¥ç¬¦åˆ API è¦æ±‚
- **è¡çªè§£æ±ºï¼š** ä¼ºæœå™¨é–“çš„å·¥å…·åç¨±è¡çªæœƒé€éè‡ªå‹•åŠ å‰ç¶´è§£æ±º

é€™ç¨®å®Œæ•´çš„æ•´åˆä½¿ MCP ä¼ºæœå™¨æˆç‚ºæ“´å±• Gemini CLI èƒ½åŠ›çš„å¼·å¤§æ–¹å¼ï¼ŒåŒæ™‚ç¶­è­·å®‰å…¨æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## å¾å·¥å…·å‚³å›è±å¯Œå…§å®¹

MCP å·¥å…·ä¸åƒ…é™æ–¼å‚³å›ç°¡å–®æ–‡å­—ã€‚æ‚¨å¯ä»¥åœ¨å–®ä¸€å·¥å…·å›æ‡‰ä¸­å‚³å›è±å¯Œçš„å¤šéƒ¨åˆ†å…§å®¹ï¼ŒåŒ…æ‹¬æ–‡å­—ã€å½±åƒã€éŸ³è¨Šå’Œå…¶ä»–äºŒé€²ä½è³‡æ–™ã€‚é€™è®“æ‚¨èƒ½å¤ å»ºç½®å¼·å¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨å–®ä¸€å›åˆä¸­å‘æ¨¡å‹æä¾›å¤šæ¨£åŒ–çš„è³‡è¨Šã€‚

å¾å·¥å…·å‚³å›çš„æ‰€æœ‰è³‡æ–™éƒ½æœƒè¢«è™•ç†ä¸¦ä½œç‚ºå…§å®¹å‚³é€çµ¦æ¨¡å‹é€²è¡Œä¸‹ä¸€æ¬¡ç”Ÿæˆï¼Œä½¿å…¶èƒ½å¤ æ¨ç†æˆ–ç¸½çµæä¾›çš„è³‡è¨Šã€‚

### é‹ä½œæ–¹å¼

è¦å‚³å›è±å¯Œå…§å®¹ï¼Œæ‚¨çš„å·¥å…·å›æ‡‰å¿…é ˆéµå¾ª [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result) çš„ MCP è¦ç¯„ã€‚çµæœçš„ `content` æ¬„ä½æ‡‰è©²æ˜¯ `ContentBlock` ç‰©ä»¶çš„é™£åˆ—ã€‚Gemini CLI æœƒæ­£ç¢ºè™•ç†æ­¤é™£åˆ—ï¼Œå°‡æ–‡å­—èˆ‡äºŒé€²ä½è³‡æ–™åˆ†é›¢ä¸¦ç‚ºæ¨¡å‹æ‰“åŒ…ã€‚

æ‚¨å¯ä»¥åœ¨ `content` é™£åˆ—ä¸­æ··åˆæ­é…ä¸åŒçš„å…§å®¹å€å¡Šé¡å‹ã€‚æ”¯æ´çš„å€å¡Šé¡å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource`ï¼ˆåµŒå…¥å…§å®¹ï¼‰
- `resource_link`

### ç¯„ä¾‹ï¼šå‚³å›æ–‡å­—å’Œå½±åƒ

ä»¥ä¸‹æ˜¯ MCP å·¥å…·çš„æœ‰æ•ˆ JSON å›æ‡‰ç¯„ä¾‹ï¼Œå‚³å›æ–‡å­—èªªæ˜å’Œå½±åƒï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "é€™æ˜¯æ‚¨è«‹æ±‚çš„æ¨™èªŒã€‚"
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "æ­¤æ¨™èªŒå‰µå»ºæ–¼ 2025 å¹´ã€‚"
    }
  ]
}
```

ç•¶ Gemini CLI æ”¶åˆ°æ­¤å›æ‡‰æ™‚ï¼Œå®ƒæœƒï¼š

1. æå–æ‰€æœ‰æ–‡å­—ä¸¦å°‡å…¶åˆä½µç‚ºæ¨¡å‹çš„å–®ä¸€ `functionResponse` éƒ¨åˆ†ã€‚
2. å°‡å½±åƒè³‡æ–™ä½œç‚ºç¨ç«‹çš„ `inlineData` éƒ¨åˆ†å‘ˆç¾ã€‚
3. åœ¨ CLI ä¸­æä¾›ä¹¾æ·¨ã€ä½¿ç”¨è€…å‹å–„çš„æ‘˜è¦ï¼ŒæŒ‡ç¤ºå·²æ”¶åˆ°æ–‡å­—å’Œå½±åƒã€‚

é€™è®“æ‚¨èƒ½å¤ å»ºç½®è¤‡é›œçš„å·¥å…·ï¼Œç‚º Gemini æ¨¡å‹æä¾›è±å¯Œçš„å¤šæ¨¡æ…‹å…§å®¹ã€‚

## MCP æç¤ºä½œç‚ºæ–œç·šæŒ‡ä»¤

é™¤äº†å·¥å…·ä¹‹å¤–ï¼ŒMCP ä¼ºæœå™¨é‚„å¯ä»¥æš´éœ²é å®šç¾©çš„æç¤ºï¼Œé€™äº›æç¤ºå¯ä»¥åœ¨ Gemini CLI å…§ä½œç‚ºæ–œç·šæŒ‡ä»¤åŸ·è¡Œã€‚é€™è®“æ‚¨å¯ä»¥ç‚ºå¸¸è¦‹æˆ–è¤‡é›œæŸ¥è©¢å»ºç«‹æ·å¾‘ï¼Œå¯ä»¥è¼•é¬†é€éåç¨±å‘¼å«ã€‚

### åœ¨ä¼ºæœå™¨ä¸Šå®šç¾©æç¤º

ä»¥ä¸‹æ˜¯å®šç¾©æç¤ºçš„ stdio MCP ä¼ºæœå™¨å°ç¯„ä¾‹ï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'Poem Writer',
    description: 'Write a nice haiku',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `å¯«ä¸€é¦–${mood ? `å¸¶æœ‰ ${mood} æƒ…ç·’çš„` : ''}åç‚º ${title} çš„ä¿³å¥ã€‚è«‹æ³¨æ„ä¿³å¥æ˜¯ 5 å€‹éŸ³ç¯€ï¼Œæ¥è‘— 7 å€‹éŸ³ç¯€ï¼Œå†æ¥è‘— 5 å€‹éŸ³ç¯€`,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

é€™å¯ä»¥åœ¨ `settings.json` çš„ `mcpServers` ä¸‹åŒ…å«ï¼š

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["filename.ts"]
    }
  }
}
```

### å‘¼å«æç¤º

ä¸€æ—¦æç¤ºè¢«æ¢ç´¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å…¶åç¨±ä½œç‚ºæ–œç·šæŒ‡ä»¤ä¾†å‘¼å«å®ƒã€‚CLI æœƒè‡ªå‹•è™•ç†è§£æå¼•æ•¸ã€‚

```bash
/poem-writer --title="Gemini CLI" --mood="reverent"
```

or, using positional arguments:

```bash
/poem-writer "Gemini CLI" reverent
```

When you run this command, the Gemini CLI executes the `prompts/get` method on the MCP server with the provided arguments. The server is responsible for substituting the arguments into the prompt template and returning the final prompt text. The CLI then sends this prompt to the model for execution. This provides a convenient way to automate and share common workflows.

## ä½¿ç”¨ `gemini mcp` ç®¡ç† MCP ä¼ºæœå™¨

é›–ç„¶æ‚¨éš¨æ™‚å¯ä»¥é€éæ‰‹å‹•ç·¨è¼¯ `settings.json` æª”æ¡ˆä¾†è¨­å®š MCP ä¼ºæœå™¨ï¼Œä½† Gemini CLI æä¾›äº†ä¸€å¥—ä¾¿åˆ©çš„æŒ‡ä»¤ä¾†ç¨‹å¼åŒ–ç®¡ç†æ‚¨çš„ä¼ºæœå™¨è¨­å®šã€‚é€™äº›æŒ‡ä»¤ç°¡åŒ–äº†æ–°å¢ã€åˆ—å‡ºå’Œç§»é™¤ MCP ä¼ºæœå™¨çš„æµç¨‹ï¼Œç„¡éœ€ç›´æ¥ç·¨è¼¯ JSON æª”æ¡ˆã€‚

### æ–°å¢ä¼ºæœå™¨ï¼ˆ`gemini mcp add`ï¼‰

`add` æŒ‡ä»¤æœƒåœ¨æ‚¨çš„ `settings.json` ä¸­è¨­å®šæ–°çš„ MCP ä¼ºæœå™¨ã€‚æ ¹æ“šç¯„åœï¼ˆ`-s, --scope`ï¼‰ï¼Œå®ƒæœƒè¢«æ–°å¢åˆ°ä½¿ç”¨è€…è¨­å®š `~/.gemini/settings.json` æˆ–å°ˆæ¡ˆè¨­å®š `.gemini/settings.json` æª”æ¡ˆä¸­ã€‚

**æŒ‡ä»¤ï¼š**

```bash
gemini mcp add [é¸é …] <åç¨±> <æŒ‡ä»¤æˆ–URL> [å¼•æ•¸...]
```

- `<åç¨±>`ï¼šä¼ºæœå™¨çš„å”¯ä¸€åç¨±ã€‚
- `<æŒ‡ä»¤æˆ–URL>`ï¼šè¦åŸ·è¡Œçš„æŒ‡ä»¤ï¼ˆé©ç”¨æ–¼ `stdio`ï¼‰æˆ– URLï¼ˆé©ç”¨æ–¼ `http`/`sse`ï¼‰ã€‚
- `[å¼•æ•¸...]`ï¼š`stdio` æŒ‡ä»¤çš„é¸ç”¨å¼•æ•¸ã€‚

**é¸é …ï¼ˆæ——æ¨™ï¼‰ï¼š**

- `-s, --scope`ï¼šè¨­å®šç¯„åœï¼ˆuser æˆ– projectï¼‰ã€‚[é è¨­ï¼šã€Œprojectã€]
- `-t, --transport`ï¼šå‚³è¼¸é¡å‹ï¼ˆstdioã€sseã€httpï¼‰ã€‚[é è¨­ï¼šã€Œstdioã€]
- `-e, --env`ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆä¾‹å¦‚ -e KEY=valueï¼‰ã€‚
- `-H, --header`ï¼šç‚º SSE å’Œ HTTP å‚³è¼¸è¨­å®š HTTP æ¨™é ­ï¼ˆä¾‹å¦‚ -H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`ï¼šè¨­å®šé€£ç·šé€¾æ™‚æ¯«ç§’æ•¸ã€‚
- `--trust`ï¼šä¿¡ä»»ä¼ºæœå™¨ï¼ˆç•¥éæ‰€æœ‰å·¥å…·å‘¼å«ç¢ºèªæç¤ºï¼‰ã€‚
- `--description`ï¼šè¨­å®šä¼ºæœå™¨çš„èªªæ˜ã€‚
- `--include-tools`ï¼šè¦åŒ…å«çš„å·¥å…·æ¸…å–®ï¼Œä»¥é€—è™Ÿåˆ†éš”ã€‚
- `--exclude-tools`ï¼šè¦æ’é™¤çš„å·¥å…·æ¸…å–®ï¼Œä»¥é€—è™Ÿåˆ†éš”ã€‚

#### æ–°å¢ stdio ä¼ºæœå™¨

This is the default transport for running local servers.

```bash
# Basic syntax
gemini mcp add <name> <command> [args...]

# Example: Adding a local server
gemini mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# Example: Adding a local python server
gemini mcp add python-server python server.py --port 8080
```

#### Adding an HTTP server

This transport is for servers that use the streamable HTTP transport.

```bash
# Basic syntax
gemini mcp add --transport http <name> <url>

# Example: Adding an HTTP server
gemini mcp add --transport http http-server https://api.example.com/mcp/

# Example: Adding an HTTP server with an authentication header
gemini mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### Adding an SSE server

This transport is for servers that use Server-Sent Events (SSE).

```bash
# Basic syntax
gemini mcp add --transport sse <name> <url>

# Example: Adding an SSE server
gemini mcp add --transport sse sse-server https://api.example.com/sse/

# Example: Adding an SSE server with an authentication header
gemini mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### Listing Servers (`gemini mcp list`)

To view all MCP servers currently configured, use the `list` command. It displays each server's name, configuration details, and connection status.

**Command:**

```bash
gemini mcp list
```

**Example Output:**

```sh
âœ“ stdio-server: command: python3 server.py (stdio) - Connected
âœ“ http-server: https://api.example.com/mcp (http) - Connected
âœ— sse-server: https://api.example.com/sse (sse) - Disconnected
```

### Removing a Server (`gemini mcp remove`)

To delete a server from your configuration, use the `remove` command with the server's name.

**Command:**

```bash
gemini mcp remove <name>
```

**Example:**

```bash
gemini mcp remove my-server
```

This will find and delete the "my-server" entry from the `mcpServers` object in the appropriate `settings.json` file based on the scope (`-s, --scope`).
